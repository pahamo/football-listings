<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Premier League TV & radio listings for UK broadcasters. See who shows each match and when." />
  <title>Premier League — UK Listings</title>
  <style>
    /* Inline for MVP; safe to split later into styles.css */
    :root{--border:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
    a{color:inherit}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin:12px 0}
    .cardlink{display:block;text-decoration:none;color:inherit}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .row .left{display:flex;flex-direction:column}
    .filters{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 20px}
    .filters select{padding:6px 10px;border:1px solid var(--border);border-radius:8px}
    .btn{display:inline-block;margin-top:8px;border:1px solid #111;padding:8px 12px;border-radius:10px;text-decoration:none}
    .btn.small{font-size:.9rem;padding:6px 10px}
    .btn.disabled{opacity:.5;pointer-events:none}
    .btn.right{margin-top:0}
    .section{margin:28px 0}
    .section h2{margin:0 0 6px}
    .section .range{font-size:.9rem}
    /* Matchweek grouping visuals */
    .mw{border:1px solid var(--border);border-radius:14px;padding:12px 16px;margin:28px 0;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .mw-head{display:flex;justify-content:space-between;align-items:baseline;gap:12px;margin-bottom:6px}
    .mw h2{margin:0 0 2px}
    .mw .range{color:var(--muted);margin:0 0 8px}
    .mw h3{margin:16px 0 8px;padding-top:6px;border-top:1px solid var(--border);color:#111}
    .mw h3:first-of-type{border-top:0;padding-top:0}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:.85rem;color:var(--muted)}
    /* Tiny home/away dots */
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin:-1px 6px 0 0;vertical-align:middle;border:1.5px solid #111}
    .dot.home{background:#111}
    .dot.away{background:transparent}
  </style>
</head>
<body>
  <header>
    <a href="#/" style="text-decoration:none;color:inherit"><strong>Premier League — UK Listings</strong></a>
    <nav style="display:flex;gap:12px;font-size:14px">
      <a href="#/" style="text-decoration:none;color:inherit">Home</a>
      <a href="#/about" style="text-decoration:none;color:inherit;opacity:.6" aria-disabled="true">About (coming)</a>
    </nav>
  </header>

  <div class="wrap">
    <div id="status" class="muted">loading…</div>
    <div id="app"></div>
  </div>

  <script type="module">
    // ---- App version & expose globally ----
    const APP_VERSION = "v0.1.4";
    window.APP_VERSION = APP_VERSION;
    const DEFAULT_TZ = 'Europe/London';
    const LOCALE = 'en-GB';
    // Minimal country -> IANA timezone map for display; expand later
    const TZ_OPTIONS = [
      {label:'UK', tz:'Europe/London'},
      {label:'Netherlands', tz:'Europe/Amsterdam'},
      {label:'USA (Eastern)', tz:'America/New_York'},
      {label:'USA (Pacific)', tz:'America/Los_Angeles'},
      {label:'India', tz:'Asia/Kolkata'},
      {label:'Australia (Sydney)', tz:'Australia/Sydney'}
    ];

    // ---- Supabase config ----
    const SUPABASE_URL = "https://ksqyurqkqznzrntdpood.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzcXl1cnFrcXpuenJudGRwb29kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTEwNjAsImV4cCI6MjA3MjM2NzA2MH0.wVBZBEbfctB7JPnpMZkXKMGwXlYxGWjOF_AxixVo-S4";
    const H = { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` };

    // API helpers
    const PATH = {
      fixtures: `/rest/v1/fixtures`,
      teams: `/rest/v1/teams`,
      broadcasts: `/rest/v1/broadcasts_uk`,
      affiliate: `/rest/v1/affiliate_destinations`,
    };
    const orderByKickoff = `order=utc_kickoff.asc`;
    const BIG_LIMIT = 2000; // future proof list size
    const providersString = (b) => `${b.providers.display_name}${b.channel_name ? " — " + b.channel_name : ""}`;

    // ---- Tiny hash router ----
    const routes = { "/": homeView, "/match": matchView };
    window.addEventListener("hashchange", render);
    render();

    function parseHash(){
      const raw = (location.hash || "#/").slice(1);
      const [path, qs=""] = raw.split("?");
      return { path: path || "/", params: new URLSearchParams(qs) };
    }

    async function render(){
      const { path, params } = parseHash();
      const view = routes[path] || homeView;
      setStatus("loading…");
      try { await view(params); } catch(e){
        console.error(e);
        document.getElementById("app").innerHTML = `<p class=\"muted\">${e.message}</p>`;
      } finally { setStatus(""); }
    }

    function setStatus(txt){ document.getElementById("status").textContent = txt; }

    // ---- Views ----
    async function homeView(){
      const app = document.getElementById("app");
      const { params } = parseHash();
      const tzParam = params.get('tz');
      const TZ = tzParam || DEFAULT_TZ;
      const teamFilter = (params.get('team')||'').toLowerCase();
      const compFilter = (params.get('comp')||'pl');

      // Fetch fixtures directly from fixtures (ensures full coverage)
      const nowIso = new Date().toISOString();
      const rows = await jget(
        `${PATH.fixtures}?select=id,utc_kickoff,matchday,` +
        `home_team:teams!fixtures_home_team_id_fkey(name),` +
        `away_team:teams!fixtures_away_team_id_fkey(name)` +
        `&utc_kickoff=gte.${nowIso}&${orderByKickoff}&limit=${BIG_LIMIT}`
      );
      const fixtures = (rows||[]).map(r => ({
        id: r.id,
        utc_kickoff: r.utc_kickoff,
        matchday: r.matchday ?? null,
        home: r.home_team?.name,
        away: r.away_team?.name,
      })).filter(f => f.home && f.away && !Number.isNaN(Date.parse(f.utc_kickoff)));

      // Client-side filter (club & competition & matchweek)
      const teamSet = Array.from(new Set(fixtures.flatMap(f=>[f.home,f.away]))).sort((a,b)=>a.localeCompare(b));
      const mwSet = Array.from(new Set(fixtures.map(f => f.matchday).filter(n => Number.isInteger(n)))).sort((a,b)=>a-b);
      const mwParam = (params.get('mw')||'');
      const filterHTML = `
        <div class="filters">
          <label>Club
            <select id="clubFilter">
              <option value="">All clubs</option>
              ${teamSet.map(t=>`<option value="${t}">${t}</option>`).join('')}
            </select>
          </label>
          <label>Competition
            <select id="compFilter">
              <option value="pl">Premier League</option>
            </select>
          </label>
          <label>Matchweek
            <select id="mwFilter">
              <option value="">All</option>
              ${mwSet.map(n=>`<option value="${n}">MW ${n}</option>`).join('')}
            </select>
          </label>
          <label>Watching from
            <select id="tzFilter">
              ${TZ_OPTIONS.map(o=>`<option value="${o.tz}">${o.label}</option>`).join('')}
            </select>
          </label>
        </div>`;
      const filtered = fixtures.filter(f => {
        const teamOK = teamFilter ? (f.home.toLowerCase()===teamFilter || f.away.toLowerCase()===teamFilter) : true;
        const compOK = (compFilter === 'pl');
        const mwOK = mwParam ? String(f.matchday||'') === mwParam : true;
        return teamOK && compOK && mwOK;
      });

      if (!filtered.length){
        app.innerHTML = filterHTML + `<p class="muted">No upcoming fixtures.</p>`;
        const clubSel = document.getElementById('clubFilter');
        const compSel = document.getElementById('compFilter');
        const mwSel = document.getElementById('mwFilter');
        if (clubSel){ clubSel.value = teamFilter ? teamSet.find(t=>t.toLowerCase()===teamFilter) || '' : ''; }
        if (compSel){ compSel.value = compFilter; }
        if (mwSel){ mwSel.value = mwParam; }
        function updateParam(k,v){
          const { path, params } = parseHash();
          if (v) params.set(k,v); else params.delete(k);
          const qs = params.toString();
          location.hash = path + (qs?`?${qs}`:'');
        }
        clubSel?.addEventListener('change', e=> updateParam('team', e.target.value));
        compSel?.addEventListener('change', e=> updateParam('comp', e.target.value));
        mwSel?.addEventListener('change', e=> updateParam('mw', e.target.value));
        return;
      }

      // Batch-load broadcasts for all fixtures (single request) and map by fixture_id
      let bmap = {};
      const ids = filtered.map(f => f.id);
      if (ids.length) {
        const qs = ids.join(',');
        try {
          const brows = await jget(`${PATH.broadcasts}?select=fixture_id,channel_name,providers(display_name)&fixture_id=in.(${qs})`);
          for (const b of (brows || [])){
            if (!bmap[b.fixture_id]) bmap[b.fixture_id] = [];
            bmap[b.fixture_id].push(b);
          }
        } catch (_) { /* ignore; show TBC */ }
      }

      // Date formatters
      const dayHeading = new Intl.DateTimeFormat(LOCALE, { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric', timeZone: TZ });
      const timeOnly   = new Intl.DateTimeFormat(LOCALE, { timeStyle: 'short', timeZone: TZ });
      const ymd        = new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' }); // YYYY-MM-DD
      const pretty     = new Intl.DateTimeFormat(LOCALE, { day:'numeric', month:'short', timeZone: TZ });
      
      // Helper: render one day's cards
      const renderCards = (items) => items.map(f => {
        const kickoffTime = timeOnly.format(new Date(f.utc_kickoff));
        const hasB = (bmap[f.id] || []).length > 0;
        return `
          <a class="cardlink" href="#/match?id=${f.id}">
            <div class="card">
              <div class="row">
                <div class="left">
                  <div>
                    <span class="dot home" aria-label="Home" title="Home"></span><strong>${f.home}</strong>
                    &nbsp;vs&nbsp;
                    <span class="dot away" aria-label="Away" title="Away"></span><strong>${f.away}</strong>
                  </div>
                  <div class="muted">${kickoffTime}</div>
                </div>
                <div>
                  <a class="${hasB ? 'btn small right' : 'btn small right disabled'}" href="#/match?id=${f.id}">${hasB ? 'Watch options' : 'Broadcasts (TBC)'}</a>
                </div>
              </div>
            </div>
          </a>`;
      }).join('');
      
      // Render sections per matchweek
      const sections = Array.from(new Map(
        filtered.reduce((map,f) => {
          const mw = f.matchday ?? 0;
          if (!map.has(mw)) map.set(mw, []);
          map.get(mw).push(f);
          return map;
        }, new Map())
      ).entries())
        .sort(([a],[b]) => (a||0) - (b||0))
        .map(([mw, items]) => {
          // Group by UK day inside the MW
          const byDay = new Map();
          for (const f of items){
            const key = ymd.format(new Date(f.utc_kickoff));
            if (!byDay.has(key)) byDay.set(key, []);
            byDay.get(key).push(f);
          }
          // Determine MW date span for heading
          const dates = items.map(f => new Date(f.utc_kickoff)).sort((a,b)=>a-b);
          const first = pretty.format(dates[0]);
          const last  = pretty.format(dates[dates.length-1]);
          const range = first === last ? first : `${first} – ${last}`;
          const mwLabel = mw > 0 ? `Matchweek ${mw}` : 'Upcoming matches';
          
          const inner = Array.from(byDay.entries())
            .sort(([a],[b])=> a.localeCompare(b))
            .map(([key, dayItems]) => {
              const headingLabel = dayHeading.format(new Date(dayItems[0].utc_kickoff));
              // Ensure chronological within day
              dayItems.sort((x,y) => new Date(x.utc_kickoff) - new Date(y.utc_kickoff));
              return `<h3 class="muted">${headingLabel}</h3>` + renderCards(dayItems);
            }).join('');
          
          return `<section class="section mw">
            <div class="mw-head">
              <h2>${mwLabel}</h2>
              <span class="pill">${range}</span>
            </div>
            ${inner}
          </section>`;
        }).join('');
      
      const tzLabel = (TZ_OPTIONS.find(o=>o.tz===TZ)?.label || 'UK') + ` (${TZ})`;
      app.innerHTML = `<p class="muted" style="margin:4px 0 16px">All times ${tzLabel}</p>` + filterHTML + sections;
      const clubSel = document.getElementById('clubFilter');
      const compSel = document.getElementById('compFilter');
      const mwSel = document.getElementById('mwFilter');
      const tzSel = document.getElementById('tzFilter');
      if (clubSel){ clubSel.value = teamFilter ? teamSet.find(t=>t.toLowerCase()===teamFilter) || '' : ''; }
      if (compSel){ compSel.value = compFilter; }
      if (mwSel){ mwSel.value = mwParam; }
      if (tzSel){ tzSel.value = TZ; }
      function updateParam(k,v){
        const { path, params } = parseHash();
        if (v) params.set(k,v); else params.delete(k);
        const qs = params.toString();
        location.hash = path + (qs?`?${qs}`:'');
      }
      clubSel?.addEventListener('change', e=> updateParam('team', e.target.value));
      compSel?.addEventListener('change', e=> updateParam('comp', e.target.value));
      mwSel?.addEventListener('change', e=> updateParam('mw', e.target.value));
      tzSel?.addEventListener('change', e=> updateParam('tz', e.target.value));
    }

    async function matchView(params){
      const app = document.getElementById("app");
      const id = params.get("id");
      if (!id){ app.innerHTML = `<p class="muted">Missing ?id=… <a href=\"#/\">Go back</a></p>`; return; }

      const { params: _p } = parseHash();
      const tzView = _p.get('tz') || DEFAULT_TZ;

      const [fixture] = await jget(`${PATH.fixtures}?id=eq.${id}&select=id,utc_kickoff,home_team_id,away_team_id,venue`);
      if (!fixture){ app.innerHTML = `<p class="muted">Fixture not found. <a href=\"#/\">Home</a></p>`; return; }

      const teams = await jget(`${PATH.teams}?id=in.(${[fixture.home_team_id, fixture.away_team_id].join(",")})&select=id,name`);
      const tById = Object.fromEntries(teams.map(t=>[t.id,t.name]));

      const bcasts = await jget(`${PATH.broadcasts}?fixture_id=eq.${id}&select=provider_id,channel_name,stream_type,verified,verified_at,providers!inner(id,display_name)`);
      // Affiliate URLs (with harmless demo fallback if none exists)
      const provIds = [...new Set(bcasts.map(b => b.provider_id))];
      let affiliatesByProv = {};
      if (provIds.length) {
        const aff = await jget(`${PATH.affiliate}?provider_id=in.(${provIds.join(",")})&select=provider_id,affiliate_url`);
        affiliatesByProv = Object.fromEntries(aff.map(a => [a.provider_id, a.affiliate_url]));
      }
      const demoFallback = (providerName) => `https://example.com/demo?provider=${encodeURIComponent(providerName)}&fixture=${encodeURIComponent(id)}`;
      const df = new Intl.DateTimeFormat(LOCALE, { dateStyle: "medium", timeStyle: "short", timeZone: tzView });

      app.innerHTML = `
        <a href=\"#/\" class=\"muted\">← Back</a>
        <h1 style=\"margin:8px 0\">${tById[fixture.home_team_id]} vs ${tById[fixture.away_team_id]}</h1>
        <div class=\"muted\">${df.format(new Date(fixture.utc_kickoff))}${fixture.venue? " — "+fixture.venue: ""}</div>
        <div id=\"providers\"></div>`;

      const order = { tv:1, ott:2, radio:3 };
      bcasts.sort((a,b)=> (order[a.stream_type]||9)-(order[b.stream_type]||9));
      const provBox = document.getElementById("providers");
      provBox.innerHTML = bcasts.length ? bcasts.map(b=>{
        const name = b.providers.display_name;
        const channel = b.channel_name ? ` — ${b.channel_name}` : "";
        const verify = b.verified ? `✅ Verified ${b.verified_at ?? ""}` : "Unverified";
        const affUrl = affiliatesByProv[b.provider_id] || demoFallback(name);
        const showBtn = (b.stream_type !== "radio");
        return `
          <div class=\"card\">
            <div><strong>${name}${channel}</strong> <span class=\"muted\">(${b.stream_type})</span></div>
            <div class=\"muted\" style=\"margin-top:4px\">${verify}</div>
            ${showBtn ? `<a class=\"btn\" href=\"${affUrl}\" target=\"_blank\" rel=\"nofollow noopener\">Watch on ${name}</a>` : ``}
          </div>`;
      }).join("") : `<div class=\"card\"><span class=\"muted\">No UK broadcaster listed yet.</span></div>`;
    }

    // ---- helper ----
    async function jget(path){
      const r = await fetch(`${SUPABASE_URL}${path}`, { headers: H });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }
  </script>

  <!-- Version badge -->
  <div id="ver" style="position:fixed;right:12px;bottom:12px;background:#111;color:#fff;font:12px/1 system-ui;padding:6px 8px;border-radius:8px;opacity:.85;z-index:9999"></div>
  <script>
    // Keep version badge inline; switch to app.js later if desired
    document.addEventListener('DOMContentLoaded', function(){
      const v = (window.APP_VERSION && typeof window.APP_VERSION === 'string') ? window.APP_VERSION : 'v0.0.0';
      var el = document.getElementById('ver');
      if (el) el.textContent = v;
    });
  </script>

  <!-- Plausible (replace domain when ready) -->
  <script defer data-domain="football-listings.netlify.app" src="https://plausible.io/js/script.js"></script>
</body>
</html>