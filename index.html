<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Premier League Fixtures & TV Guide - Where to Watch</title>
    <meta name="description" content="Find out which TV channel is showing Premier League matches today. Complete fixture list with Sky Sports, TNT Sports, Amazon Prime and BBC broadcaster information.">
    <meta name="keywords" content="Premier League, TV guide, fixtures, Sky Sports, TNT Sports, Amazon Prime, BBC, where to watch football">
    
    <!-- Open Graph for Social Sharing -->
    <meta property="og:title" content="Premier League Fixtures & TV Guide">
    <meta property="og:description" content="Never miss a match - find out which channel is showing your team's games">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://football-listings.netlify.app">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }
        
        /* Status Messages */
        .status {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Filters */
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .filter-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        /* Matchweek Groups */
        .matchweek-group {
            margin-bottom: 2rem;
        }
        
        .matchweek-header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .matchweek-fixtures {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Fixtures */
        .fixture {
            border-bottom: 1px solid #eee;
            padding: 1.5rem;
            transition: background-color 0.2s;
        }
        
        .fixture:hover {
            background-color: #f8f9fa;
        }
        
        .fixture:last-child {
            border-bottom: none;
        }
        
        .fixture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .fixture-teams {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .team-badge {
            width: 32px;
            height: 32px;
            background: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: #666;
            border: 1px solid #ddd;
            overflow: hidden;
        }
        
        .team-badge img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }
        
        .vs-text {
            color: #7f8c8d;
            font-weight: normal;
            font-size: 0.9em;
        }
        
        .fixture-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }
        
        .fixture-date {
            color: #7f8c8d;
            font-size: 0.95rem;
        }
        
        .fixture-venue {
            color: #95a5a6;
            font-size: 0.85rem;
        }
        
        .broadcasters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .no-fixtures {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
            font-size: 1.1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Footer */
        footer {
            margin-top: 3rem;
            padding: 2rem 0;
            text-align: center;
            color: #7f8c8d;
            border-top: 1px solid #eee;
        }
        
        .version-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .fixture-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .fixture-teams {
                font-size: 1.1rem;
            }
            
            .fixture-info {
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Premier League Fixtures</h1>
            <p class="subtitle">Find out which TV channel is showing your team's matches</p>
        </div>
    </header>

    <main class="container">
        <!-- Status Messages -->
        <div id="status"></div>
        
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label for="team-filter">Filter by Team:</label>
                <select id="team-filter">
                    <option value="">All Teams</option>
                </select>
                
                <label for="matchweek-filter">Matchweek:</label>
                <select id="matchweek-filter">
                    <option value="">All Matchweeks</option>
                </select>
                
                <label for="time-filter">Show:</label>
                <select id="time-filter">
                    <option value="upcoming">Upcoming Only</option>
                    <option value="all">All Fixtures</option>
                </select>
            </div>
        </div>

        <!-- Fixtures List -->
        <div id="fixtures-container"></div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Football Listings. Find where to watch Premier League matches on TV.</p>
            <p>Data provided by TheSportsDB. Broadcaster information updated regularly.</p>
        </div>
    </footer>

    <div class="version-badge">v1.5.0</div>

    <script>
        const SUPABASE_URL = 'https://ksqyurqkqznzrntdpood.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzcXl1cnFrcXpuenJudGRwb29kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTEwNjAsImV4cCI6MjA3MjM2NzA2MH0.wVBZBEbfctB7JPnpMZkXKMGwXlYxGWjOF_AxixVo-S4';

        // Global state
        let allTeams = [];
        let allFixtures = [];
        let teamsMap = {};

        // Utility Functions
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function hideStatus() {
            document.getElementById('status').innerHTML = '';
        }

        function getTeamAbbreviation(teamName) {
            const abbreviations = {
                'Arsenal': 'ARS',
                'Aston Villa': 'AVL',
                'Brighton & Hove Albion': 'BHA',
                'Brighton': 'BHA',
                'Burnley': 'BUR',
                'Chelsea': 'CHE',
                'Crystal Palace': 'CRY',
                'Everton': 'EVE',
                'Fulham': 'FUL',
                'Liverpool': 'LIV',
                'Luton Town': 'LUT',
                'Manchester City': 'MCI',
                'Manchester United': 'MUN',
                'Newcastle United': 'NEW',
                'Newcastle': 'NEW',
                'Nottingham Forest': 'NFO',
                'Sheffield United': 'SHU',
                'Tottenham Hotspur': 'TOT',
                'Tottenham': 'TOT',
                'West Ham United': 'WHU',
                'West Ham': 'WHU',
                'Wolverhampton Wanderers': 'WOL',
                'Wolves': 'WOL',
                'Brentford': 'BRE',
                'Leicester City': 'LEI',
                'Leeds United': 'LEE',
                'Sunderland': 'SUN'
            };
            
            return abbreviations[teamName] || teamName.substring(0, 3).toUpperCase();
        }

        function getTeamCrestUrl(teamName) {
            const crestUrls = {
                'Arsenal': 'https://www.thesportsdb.com/images/media/team/badge/vrtrtp1448813175.png',
                'Aston Villa': 'https://www.thesportsdb.com/images/media/team/badge/yvwvtu1448813188.png',
                'Brighton & Hove Albion': 'https://www.thesportsdb.com/images/media/team/badge/wwxuyw1448813221.png',
                'Brighton': 'https://www.thesportsdb.com/images/media/team/badge/wwxuyw1448813221.png',
                'Chelsea': 'https://www.thesportsdb.com/images/media/team/badge/yvwvtu1448813225.png',
                'Crystal Palace': 'https://www.thesportsdb.com/images/media/team/badge/vwpvry1467462651.png',
                'Everton': 'https://www.thesportsdb.com/images/media/team/badge/vwpvry1467462685.png',
                'Fulham': 'https://www.thesportsdb.com/images/media/team/badge/adklsj1672750184.png',
                'Liverpool': 'https://www.thesportsdb.com/images/media/team/badge/txrxpy1448813215.png',
                'Manchester City': 'https://www.thesportsdb.com/images/media/team/badge/vwpvry1467462692.png',
                'Manchester United': 'https://www.thesportsdb.com/images/media/team/badge/vrtrtp1448813187.png',
                'Newcastle United': 'https://www.thesportsdb.com/images/media/team/badge/wwxuyw1448813348.png',
                'Newcastle': 'https://www.thesportsdb.com/images/media/team/badge/wwxuyw1448813348.png',
                'Nottingham Forest': 'https://www.thesportsdb.com/images/media/team/badge/uyhbfe1612467038.png',
                'Tottenham Hotspur': 'https://www.thesportsdb.com/images/media/team/badge/xxrxpu1448813232.png',
                'Tottenham': 'https://www.thesportsdb.com/images/media/team/badge/xxrxpu1448813232.png',
                'West Ham United': 'https://www.thesportsdb.com/images/media/team/badge/tpwptu1467456296.png',
                'West Ham': 'https://www.thesportsdb.com/images/media/team/badge/tpwptu1467456296.png',
                'Wolverhampton Wanderers': 'https://www.thesportsdb.com/images/media/team/badge/1yhpte1646072327.png',
                'Wolves': 'https://www.thesportsdb.com/images/media/team/badge/1yhpte1646072327.png',
                'Brentford': 'https://www.thesportsdb.com/images/media/team/badge/qtpsps1420049324.png',
                'Leicester City': 'https://www.thesportsdb.com/images/media/team/badge/uvxutp1448813130.png',
                'Sunderland': 'https://www.thesportsdb.com/images/media/team/badge/rwqrrq1448813106.png'
            };
            
            return crestUrls[teamName] || null;
        }

        // Data Loading Functions
        async function loadTeams() {
            showStatus('Loading teams...', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/teams?select=id,name,slug,crest_url&order=name`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Teams API failed: ${response.status}`);
                }
                
                allTeams = await response.json();
                
                // Create teams lookup
                teamsMap = {};
                allTeams.forEach(team => {
                    teamsMap[team.id] = team;
                });
                
                // Populate team filter
                const teamFilter = document.getElementById('team-filter');
                teamFilter.innerHTML = '<option value="">All Teams</option>';
                allTeams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamFilter.appendChild(option);
                });
                
                console.log('Teams loaded:', allTeams.length);
                return true;
                
            } catch (error) {
                console.error('Error loading teams:', error);
                showStatus(`Error loading teams: ${error.message}`, 'error');
                return false;
            }
        }

        async function loadFixtures() {
            showStatus('Loading fixtures...', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/fixtures?select=id,home_team_id,away_team_id,utc_kickoff,matchweek,venue&order=utc_kickoff`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Fixtures API failed: ${response.status}`);
                }
                
                allFixtures = await response.json();
                console.log('Fixtures loaded:', allFixtures.length);
                
                // Populate matchweek filter
                populateMatchweekFilter();
                
                displayFixtures();
                return true;
                
            } catch (error) {
                console.error('Error loading fixtures:', error);
                showStatus(`Error loading fixtures: ${error.message}`, 'error');
                return false;
            }
        }

        function populateMatchweekFilter() {
            const matchweekFilter = document.getElementById('matchweek-filter');
            const matchweeks = [...new Set(allFixtures.map(f => f.matchweek).filter(m => m))].sort((a, b) => a - b);
            
            matchweekFilter.innerHTML = '<option value="">All Matchweeks</option>';
            matchweeks.forEach(matchweek => {
                const option = document.createElement('option');
                option.value = matchweek;
                option.textContent = `Matchweek ${matchweek}`;
                matchweekFilter.appendChild(option);
            });
        }

        function getFilteredFixtures() {
            const teamFilter = document.getElementById('team-filter').value;
            const matchweekFilter = document.getElementById('matchweek-filter').value;
            const timeFilter = document.getElementById('time-filter').value;
            
            let filtered = allFixtures;

            // Team filter
            if (teamFilter) {
                filtered = filtered.filter(fixture => 
                    fixture.home_team_id == teamFilter || 
                    fixture.away_team_id == teamFilter
                );
            }

            // Matchweek filter
            if (matchweekFilter) {
                filtered = filtered.filter(fixture => 
                    fixture.matchweek == matchweekFilter
                );
            }

            // Time filter
            if (timeFilter === 'upcoming') {
                const now = new Date();
                filtered = filtered.filter(fixture => 
                    new Date(fixture.utc_kickoff) > now
                );
            }

            return filtered;
        }

        function groupFixtures(fixtures) {
            const groups = {};
            
            fixtures.forEach(fixture => {
                const groupKey = fixture.matchweek ? `Matchweek ${fixture.matchweek}` : 'No Matchweek';
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(fixture);
            });
            
            return groups;
        }

        function renderFixture(fixture) {
            const homeTeam = teamsMap[fixture.home_team_id];
            const awayTeam = teamsMap[fixture.away_team_id];
            
            if (!homeTeam || !awayTeam) {
                return '';
            }
            
            const kickoffDate = new Date(fixture.utc_kickoff);
            const dateStr = kickoffDate.toLocaleDateString('en-GB', {
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Get crest URLs with fallbacks
            const homeCrestUrl = homeTeam.crest_url || getTeamCrestUrl(homeTeam.name);
            const awayCrestUrl = awayTeam.crest_url || getTeamCrestUrl(awayTeam.name);
            const homeAbbr = getTeamAbbreviation(homeTeam.name);
            const awayAbbr = getTeamAbbreviation(awayTeam.name);
            
            return `
                <div class="fixture">
                    <div class="fixture-header">
                        <div class="fixture-teams">
                            <div class="team-badge">
                                ${homeCrestUrl ? 
                                    `<img src="${homeCrestUrl}" alt="${homeTeam.name}" onerror="this.style.display='none'; this.nextSibling.style.display='block';">
                                     <span style="display:none">${homeAbbr}</span>` :
                                    homeAbbr
                                }
                            </div>
                            <span>${homeTeam.name}</span>
                            <span class="vs-text">vs</span>
                            <span>${awayTeam.name}</span>
                            <div class="team-badge">
                                ${awayCrestUrl ? 
                                    `<img src="${awayCrestUrl}" alt="${awayTeam.name}" onerror="this.style.display='none'; this.nextSibling.style.display='block';">
                                     <span style="display:none">${awayAbbr}</span>` :
                                    awayAbbr
                                }
                            </div>
                        </div>
                        <div class="fixture-info">
                            <div class="fixture-date">${dateStr}</div>
                            ${fixture.venue ? `<div class="fixture-venue">${fixture.venue}</div>` : ''}
                        </div>
                    </div>
                    <div class="broadcasters">
                        <span style="color: #7f8c8d;">Broadcaster TBC</span>
                    </div>
                </div>
            `;
        }

        function displayFixtures() {
            const fixturesContainer = document.getElementById('fixtures-container');
            const filtered = getFilteredFixtures();
            
            if (filtered.length === 0) {
                fixturesContainer.innerHTML = '<div class="no-fixtures">No fixtures found matching your filters.</div>';
                hideStatus();
                return;
            }
            
            const grouped = groupFixtures(filtered);
            
            let html = '';
            
            Object.entries(grouped).forEach(([groupName, fixtures]) => {
                html += `
                    <div class="matchweek-group">
                        <div class="matchweek-header">${groupName}</div>
                        <div class="matchweek-fixtures">
                `;
                
                fixtures.forEach(fixture => {
                    html += renderFixture(fixture);
                });
                
                html += '</div></div>';
            });
            
            fixturesContainer.innerHTML = html;
            showStatus(`Showing ${filtered.length} fixtures`, 'success');
            
            // Hide status after 2 seconds
            setTimeout(hideStatus, 2000);
        }

        // Event Listeners
        document.getElementById('team-filter').addEventListener('change', displayFixtures);
        document.getElementById('matchweek-filter').addEventListener('change', displayFixtures);
        document.getElementById('time-filter').addEventListener('change', displayFixtures);

        // Initialize App
        async function initApp() {
            try {
                const teamsLoaded = await loadTeams();
                if (teamsLoaded) {
                    const fixturesLoaded = await loadFixtures();
                    if (fixturesLoaded) {
                        console.log('App initialized successfully');
                    }
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                showStatus('Failed to load fixtures. Please refresh the page.', 'error');
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>