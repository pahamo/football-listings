<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta id="meta-description" name="description" content="Premier League TV schedule UK - Find which broadcaster shows every match: Sky Sports, TNT Sports, BBC. Live fixtures, times & channels." />
  
  <!-- Security headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  
  <!-- SEO and social media -->
  <meta name="robots" content="index, follow" />
  <meta name="author" content="Patrick Hallett-Morley" />
  <meta id="og-title" property="og:title" content="Premier League TV Schedule UK | fixtures.app" />
  <meta id="og-description" property="og:description" content="Find which broadcaster shows every Premier League match - Sky Sports, TNT Sports, BBC. Live fixtures, times & channels." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://football-listings.netlify.app/" />
  <meta property="og:site_name" content="fixtures.app" />
  <meta property="og:image" content="https://football-listings.netlify.app/assets/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="en_GB" />
  
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta id="twitter-title" name="twitter:title" content="Premier League TV Schedule UK" />
  <meta id="twitter-description" name="twitter:description" content="Find which broadcaster shows every Premier League match - Sky Sports, TNT Sports, BBC." />
  <meta name="twitter:image" content="https://football-listings.netlify.app/assets/og-image.png" />
  <meta name="twitter:site" content="@fixturesa" />
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect rx='6' width='32' height='32' fill='%23111'/><rect x='10' y='6' width='3' height='3' rx='1' fill='%23fff'/><rect x='19' y='6' width='3' height='3' rx='1' fill='%23fff'/><rect x='7' y='10' width='18' height='14' rx='2' fill='none' stroke='%23fff' stroke-width='2'/><circle cx='22' cy='21' r='2' fill='%23fff'/></svg>">
  <title id="page-title">Premier League TV Schedule UK | fixtures.app</title>
  <style>
    /* ==============================================
       Premier League Listings - Inline Styles
       Optimized for performance and maintainability
       ============================================== */
       
    /* CSS Custom Properties */
    :root {
      --color-border: #e5e7eb;
      --color-muted: #6b7280;
      --color-background: #f8fafc;
      --color-card: #ffffff;
      --color-text: #111827;
      --color-accent: #6366f1;
      --border-radius: 12px;
      
      /* Competition-specific colors (set dynamically) */
      --competition-primary: #38003c; /* Default Premier League */
      --competition-secondary: #00ff87;
      --border-radius-pill: 999px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,.06), 0 6px 16px rgba(0,0,0,.04);
      --shadow-md: 0 3px 8px rgba(0,0,0,.08), 0 10px 24px rgba(0,0,0,.06);
      --font-system: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* Base Styles */
    * { box-sizing: border-box; }
    
    body {
      font-family: var(--font-system);
      margin: 0;
      background: var(--color-background);
      color: var(--color-text);
    }
    
    a { color: inherit; }
    
    /* Layout Components */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg) var(--spacing-xl);
      border-bottom: 1px solid var(--color-border);
    }
    
    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }
    
    .muted { color: var(--color-muted); }
    /* Card Components */
    .card {
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 14px var(--spacing-lg);
      margin: var(--spacing-md) 0;
      background: var(--color-card);
      box-shadow: var(--shadow-sm);
      transition: box-shadow .15s ease, transform .15s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .cardlink {
      display: block;
      text-decoration: none;
      color: inherit;
    }
    
    /* Layout Components */
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }
    
    .row .left {
      display: flex;
      flex-direction: column;
    }
    
    /* Form Components */
    .filters {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      margin: var(--spacing-sm) 0 var(--spacing-xl);
    }
    
    .filters select {
      padding: 6px 10px;
      border: 1px solid var(--color-border);
      border-radius: var(--spacing-sm);
      font-family: inherit;
    }
    
    /* Button Components */
    .btn {
      display: inline-block;
      margin-top: var(--spacing-sm);
      border: 1px solid var(--color-text);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 10px;
      text-decoration: none;
      font-family: inherit;
      cursor: pointer;
      transition: opacity .15s ease;
    }
    
    .btn.small {
      font-size: .9rem;
      padding: 6px 10px;
    }
    
    .btn.disabled {
      opacity: .5;
      pointer-events: none;
    }
    
    .btn.right {
      margin-top: 0;
    }
    .section{margin:28px 0}
    .section h2{margin:0 0 6px}
    .section .range{font-size:.9rem}
    /* Matchweek grouping visuals */
    .mw{border:1px solid var(--border);border-radius:14px;padding:12px 16px;margin:28px 0;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .mw-head{display:flex;justify-content:space-between;align-items:baseline;gap:12px;margin-bottom:8px}
    .mw h2{margin:0 0 2px}
    .mw .range{color:var(--muted);margin:0 0 8px}
    .mw h3{margin:16px 0 8px;padding-top:6px;border-top:1px solid var(--border);color:#111}
    .mw h3:first-of-type{border-top:0;padding-top:0}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:.85rem;color:var(--muted)}
    /* Tiny home/away dots */
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin:-1px 6px 0 0;vertical-align:middle;border:1.5px solid #111}
    .dot.home{background:#111}
    .dot.away{background:transparent}
    /* Team badges */
    .team-row{display:flex;align-items:center;gap:8px}
    .crest{width:18px;height:18px;object-fit:contain;vertical-align:middle}
    .teams-stack{display:grid;grid-template-columns:1fr;gap:6px}
    /* Large crests variant (enabled via ?largeCrests=1 which adds .large-crests on <html>) */
    .large-crests .crest{width:28px;height:28px}
    .large-crests .team-row{gap:10px}
    .large-crests .teams-stack{gap:10px}

    /* Featured card variant + time grouping labels */
    .featured{box-shadow:0 4px 20px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);border-width:2px}
    .time-group{display:flex;align-items:center;gap:10px;margin:8px 0 6px;color:var(--muted)}
    .time-dot{width:8px;height:8px;border-radius:50%;background:#111;display:inline-block}
    /* Fixtures: side filters + crest selector */
    .layout{display:grid;grid-template-columns:260px 1fr;gap:16px}
    .main-col{max-width:720px;margin:0 auto}
    @media (max-width: 840px){
      .layout{grid-template-columns:1fr}
      .filters-rail{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:10px 12px;border-radius:12px 12px 0 0}
      
      /* Mobile typography fixes */
      body{font-size:16px}
      h1{font-size:24px}
      h2{font-size:20px}
      h3{font-size:18px}
      
      /* Mobile card fixes */
      .card{margin:8px 0;padding:12px 14px}
      .row{gap:8px}
      
      /* Mobile team layout fixes */
      .team-row{gap:6px;font-size:15px;min-height:20px}
      .teams-stack{gap:4px}
      .crest{width:16px;height:16px;flex-shrink:0}
      
      /* Mobile button fixes - ensure 44px touch targets */
      .btn{padding:12px 16px;min-height:44px;box-sizing:border-box;display:inline-flex;align-items:center;justify-content:center}
      .btn.small{padding:10px 14px;min-height:40px}
      
      /* Mobile crest selector fixes */
      .crest-btn{padding:8px 12px;min-height:40px;font-size:14px}
      .crest-row{gap:6px;margin:6px 0}
      
      /* Mobile filter fixes */
      .filters{gap:8px;margin:6px 0 16px}
      .filters select{padding:8px 12px;min-height:40px;font-size:16px}
      
      /* Mobile time group fixes */
      .time-group{margin:6px 0 4px;font-size:14px}
      .time-dot{width:6px;height:6px}
      
      /* Mobile section spacing */
      .section{margin:20px 0}
      
      /* Mobile layout container */
      .main-col{padding:0 12px}
      
      /* Mobile header and navigation */
      header{padding:12px 16px;flex-direction:column;align-items:flex-start;gap:12px}
      .brand{font-size:18px}
      .brand .logo{width:24px;height:24px}
      header nav{gap:8px;font-size:14px;width:100%}
      header nav a{padding:8px;min-height:32px;display:inline-flex;align-items:center}
      
      /* Mobile wrap container */
      .wrap{padding:16px 12px}
    }
    .filters-rail{position:sticky;top:12px;align-self:start;border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}
    .filters-rail h3{margin:0 0 8px;font-size:1rem}
    .filters-rail .filters{display:block;margin:0}
    .filters-rail .filters label{display:block;margin:6px 0}
    .crest-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .crest-btn{display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
    .crest-btn[aria-pressed="true"]{outline:2px solid #111}
    /* Club page feed alignment */
    .club-feed{display:block}
    .club-item{max-width:720px}
    .club-item.align-left{margin-right:auto}
    .club-item.align-right{margin-left:auto}
    /* Brand / header */
    .brand{display:flex;align-items:center;gap:10px;font-size:22px}
    .brand .logo{width:28px;height:28px;display:inline-block}
    /* Football subnav styling */
    .subnav{margin:6px 0 16px}
    .subnav .crumbs{font-size:13px;color:var(--color-muted)}
    .btn.small.active{background:var(--competition-primary);color:#fff;border-color:var(--competition-primary)}

    /* Subnav as tab bar */
    .subnav-bar{margin:0;padding:10px 0;border-bottom:1px solid var(--color-border);background:transparent;box-shadow:none;border-radius:0}
    /* Pull the subnav up so it visually attaches to the header underline */
    .wrap > .subnav-bar{margin-top:-8px}
    .subnav-inner{display:flex;align-items:flex-end;justify-content:space-between;gap:12px}
    .tabs{display:flex;gap:14px}
    .tabs .tab{display:inline-block;padding:8px 2px;border-bottom:2px solid transparent;text-decoration:none;color:inherit;opacity:.85}
    .tabs .tab:hover{opacity:1}
    .tabs .tab.active,.tabs .tab[aria-current="page"]{border-bottom-color:var(--competition-primary);color:var(--competition-primary);opacity:1;font-weight:600}
    /* Club page hero */
    .club-hero h2{font-size:1.6rem}
    .club-hero .crest{width:40px;height:40px}

    /* Clubs index grid */
    .clubs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .mini-card{padding:10px 12px}
    .club-tile{display:flex;flex-direction:column;align-items:center;gap:8px}
    .club-tile .crest{width:36px;height:36px}

    /* === Clubs grid equal sizing === */
    .clubs-grid{align-items:stretch}
    .mini-card.club-tile{min-height:120px;display:flex;align-items:center;justify-content:center;text-align:center}
    .mini-card.club-tile strong{display:block;line-height:1.1}

    /* === Featured (next match) — static, safe highlight === */
    .card.feature-next{position:relative;border-color:#a5b4fc;box-shadow:0 6px 22px rgba(99,102,241,.12),0 1px 3px rgba(0,0,0,.06), inset 0 0 0 2px rgba(99,102,241,.18);background:linear-gradient(180deg,#ffffff 0%,#f8faff 100%)}
    .card.feature-next::after{content:"";position:absolute;left:-1px;top:8px;bottom:8px;width:4px;border-radius:4px;background:linear-gradient(180deg,#6366f1,#22d3ee)}
    .pill-next{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}

    /* === Club page opponent-first variant === */
    .club-opponent .kick{font-size:1rem;margin-top:2px}
    .club-opponent .opponent-row{display:flex;align-items:center;gap:8px}
    .club-opponent .opponent-row .crest{width:22px;height:22px}

    /* Floating hint on home */
    .floater{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;border-radius:999px;padding:10px 14px;text-decoration:none;box-shadow:0 6px 24px rgba(0,0,0,.15);z-index:9999;font-size:14px}
    
    /* Accessibility: Skip navigation */
    .skip-nav:focus {
      position: absolute;
      left: var(--spacing-md);
      top: var(--spacing-md);
    }
    
    /* Competition-specific styling */
    .competition-btn:hover {
      border-color: var(--competition-primary);
      background: rgba(var(--competition-primary), 0.05);
    }
    
    .competition-dropdown.show {
      display: block !important;
      border-color: var(--color-border);
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    
    .competition-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      min-height: 48px;
      text-decoration: none;
      color: var(--color-text);
      border-bottom: 1px solid var(--color-border);
      font-size: 14px;
      transition: background-color .15s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .competition-option:last-child {
      border-bottom: none;
    }
    
    .competition-option:hover {
      background: var(--color-background);
      color: var(--color-text);
    }
    
    .competition-option img {
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }
    
    /* Use competition colors for accents */
    .pill {
      border-color: var(--competition-primary) !important;
      color: var(--competition-primary) !important;
    }
    
    nav a.active {
      color: var(--competition-primary) !important;
      border-bottom-color: var(--competition-primary) !important;
    }
    
    /* Competition-specific body classes for advanced styling */
    .comp-premier-league .brand { color: #38003c; }
    .comp-bundesliga .brand { color: #d20515; }
    .comp-la-liga .brand { color: #ee8707; }
    .comp-serie-a .brand { color: #024494; }
    .comp-ligue-1 .brand { color: #dae025; }
    
    /* Enhanced broadcast status styling */
    .broadcast-status[data-has-broadcast="false"] {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
      position: relative;
    }
    
    .broadcast-status[data-has-broadcast="false"]:hover::after {
      content: "Broadcast information will be added when announced by the Premier League";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 5px;
    }
    
    .broadcast-status[data-has-broadcast="false"]:hover::before {
      content: "";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #333;
      z-index: 1000;
    }
  </style>
  <link rel="canonical" href="">
  <script defer data-domain="football-listings.netlify.app" src="https://analytics.kinotto.co/js/script.js"></script>
</head>
<body itemscope itemtype="https://schema.org/WebSite">
  <!-- Schema.org WebSite structured data -->
  <meta itemprop="name" content="fixtures.app">
  <meta itemprop="url" content="https://football-listings.netlify.app">
  <meta itemprop="description" content="Premier League TV schedule and fixtures for UK broadcasters">
  
  <!-- Skip navigation for accessibility -->
  <a href="#app" class="skip-nav" style="position:absolute;left:-9999px;z-index:10000;background:#111;color:#fff;padding:8px;text-decoration:none;border-radius:4px;">Skip to main content</a>
  
  <!-- Breadcrumb navigation for SEO -->
  <nav aria-label="Breadcrumb" style="display:none" id="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
    <ol style="list-style:none;margin:0;padding:0;display:flex;gap:8px;font-size:14px;color:#666;">
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="#/premier-league" itemprop="item"><span itemprop="name">Premier League</span></a>
        <meta itemprop="position" content="1">
      </li>
    </ol>
  </nav>
  
  <header role="banner">
    <div class="brand-section" style="display: flex; align-items: center; gap: 16px; justify-content: space-between; width:100%">
      <a href="#/" class="brand" style="text-decoration:none;color:inherit" aria-label="Football Listings - Home">
        <img class="logo" alt="fixtures.app logo" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 32 32'><rect rx='6' width='32' height='32' fill='%23111'/><rect x='10' y='6' width='3' height='3' rx='1' fill='%23fff'/><rect x='19' y='6' width='3' height='3' rx='1' fill='%23fff'/><rect x='7' y='10' width='18' height='14' rx='2' fill='none' stroke='%23fff' stroke-width='2'/><circle cx='22' cy='21' r='2' fill='%23fff'/></svg>">
        <strong id="brand-text">fixtures.app</strong>
      </a>

      <!-- GLOBAL NAV: sports + about -->
      <nav role="navigation" aria-label="Global navigation" style="display:flex;gap:12px;font-size:14px;align-items:center">
        <a href="#/" id="nav-sport-football" class="pill" style="text-decoration:none;">Football</a>
        <a id="nav-about" href="#/about" style="text-decoration:none;color:inherit">About</a>
      </nav>
    </div>
  </header>

  <main class="wrap" role="main" itemscope itemtype="https://schema.org/SportsEvent">
    <div id="status" class="muted" aria-live="polite" aria-label="Loading status">loading…</div>
    <article id="app" role="application" aria-label="Premier League fixtures application">
      <!-- Dynamic content rendered here -->
    </article>
  </main>

  <script type="module">
    /**
     * ================================================
     * Premier League TV Listings - SPA Application
     * ================================================
     * Single-page application for viewing Premier League 
     * fixtures with UK broadcaster information
     */

    // ===========================================
    // APP CONFIGURATION & CONSTANTS
    // ===========================================
    
    /** Application version - displayed in version badge */
    const APP_VERSION = "v1.5.2";
    window.APP_VERSION = APP_VERSION;
    
    /** Default timezone and locale settings */
    const DEFAULT_TZ = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/London';
    const LOCALE = 'en-GB';

    /** Multi-Competition Configuration */
    const COMPETITIONS = {
      'premier-league': {
        id: 1,
        name: 'Premier League',
        shortName: 'EPL',
        slug: 'premier-league',
        country: 'England',
        countryCode: 'ENG',
        timezone: 'Europe/London',
        locale: 'en-GB',
        totalRounds: 38,
        totalTeams: 20,
        colors: {
          primary: '#38003c',
          secondary: '#00ff87'
        },
        isDefault: true,
        isActive: true
      },
      'bundesliga': {
        id: 2,
        name: 'Bundesliga',
        shortName: 'BL1',
        slug: 'bundesliga', 
        country: 'Germany',
        countryCode: 'GER',
        timezone: 'Europe/Berlin',
        locale: 'de-DE',
        totalRounds: 34,
        totalTeams: 18,
        colors: {
          primary: '#d20515',
          secondary: '#ffcc02'
        },
        isDefault: false,
        isActive: true
      },
      'la-liga': {
        id: 3,
        name: 'La Liga',
        shortName: 'LL',
        slug: 'la-liga',
        country: 'Spain', 
        countryCode: 'ESP',
        timezone: 'Europe/Madrid',
        locale: 'es-ES',
        totalRounds: 38,
        totalTeams: 20,
        colors: {
          primary: '#ee8707',
          secondary: '#004c99'
        },
        isDefault: false,
        isActive: true
      },
      'serie-a': {
        id: 4,
        name: 'Serie A',
        shortName: 'SA',
        slug: 'serie-a',
        country: 'Italy',
        countryCode: 'ITA',
        timezone: 'Europe/Rome',
        locale: 'it-IT',
        totalRounds: 38,
        totalTeams: 20,
        colors: {
          primary: '#004da0',
          secondary: '#009639'
        },
        isDefault: false,
        isActive: true
      },
      'ligue-1': {
        id: 5,
        name: 'Ligue 1',
        shortName: 'L1',
        slug: 'ligue-1',
        country: 'France',
        countryCode: 'FRA',
        timezone: 'Europe/Paris',
        locale: 'fr-FR',
        totalRounds: 34,
        totalTeams: 18,
        colors: {
          primary: '#dccb18',
          secondary: '#003399'
        },
        isDefault: false,
        isActive: true
      }
    };

    /** Get competition by slug */
    function getCompetition(slug) {
      return COMPETITIONS[slug] || COMPETITIONS['premier-league'];
    }

    /** Get active competitions for selector */
    function getActiveCompetitions() {
      return Object.values(COMPETITIONS).filter(c => c.isActive);
    }

    /** Get current competition from URL or default */
    function getCurrentCompetition() {
      const { path, params } = parseRoute();
      let competitionSlug = params.get('competition') || 'premier-league';
      
      // Extract from URL path (e.g., /football/bundesliga/fixtures)
      const pathParts = location.pathname.replace('/football/', '').split('/').filter(Boolean);
      if (pathParts.length > 0 && COMPETITIONS[pathParts[0]]) {
        competitionSlug = pathParts[0];
      }
      
      return getCompetition(competitionSlug);
    }
    
    /**
     * Updates navigation links to be competition-aware
     */
    function updateNavigationLinks(competitionSlug = 'premier-league') {
      const competition = getCompetition(competitionSlug);
      
      // Update main navigation links
      const navFixtures = document.getElementById('nav-fixtures');
      const navClubs = document.getElementById('nav-clubs');
      const navTable = document.getElementById('nav-table');
      
      if (navFixtures) navFixtures.href = `/football/${competition.slug}/fixtures`;
      if (navClubs) navClubs.href = `/football/${competition.slug}/clubs`;
      if (navTable) navTable.href = `/football/${competition.slug}/table`;
    }
    
    /**
     * Updates CSS custom properties for competition-specific styling
     */
    function updateCompetitionStyling(competitionSlug = 'premier-league') {
      const competition = getCompetition(competitionSlug);
      const root = document.documentElement;
      
      // Set CSS custom properties for competition colors
      root.style.setProperty('--competition-primary', competition.colors.primary);
      root.style.setProperty('--competition-secondary', competition.colors.secondary);
      
      // Add competition-specific class to body for additional styling
      document.body.className = document.body.className.replace(/\bcomp-\w+\b/g, '');
      document.body.classList.add(`comp-${competition.slug}`);
    }
    
    /** Feature flags from URL parameters */
    const featureFlags = new URLSearchParams((location.hash.split('?')[1] || ''));
    if (featureFlags.get('largeCrests') === '1') {
      document.documentElement.classList.add('large-crests');
    }
    
    /** Available timezone options for user selection */
    const TIMEZONE_OPTIONS = [
      { label: 'UK', tz: 'Europe/London' },
      { label: 'Netherlands', tz: 'Europe/Amsterdam' },
      { label: 'USA (Eastern)', tz: 'America/New_York' },
      { label: 'USA (Pacific)', tz: 'America/Los_Angeles' },
      { label: 'India', tz: 'Asia/Kolkata' },
      { label: 'Australia (Sydney)', tz: 'Australia/Sydney' }
    ];
    // ===========================================
    // UTILITY FUNCTIONS
    // ===========================================
    
    /**
     * Sets the canonical URL for SEO
     * @param {string} url - The canonical URL to set
     */
    function setCanonical(url) {
      let link = document.querySelector('link[rel="canonical"]');
      if (!link) {
        link = document.createElement('link');
        link.setAttribute('rel', 'canonical');
        document.head.appendChild(link);
      }
      link.setAttribute('href', url);
    }
    
    /**
     * Converts text to URL-friendly slug
     * @param {string} text - Text to slugify
     * @returns {string} URL-friendly slug
     */
    function slugify(text) {
      return String(text)
        .normalize('NFKD')
        .replace(/\p{Diacritic}/gu, '')
        .toLowerCase()
        .replace(/&/g, ' and ')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .replace(/-{2,}/g, '-');
    }
    
    /**
     * Formats ISO date to YYYY-MM-DD
     * @param {string} isoDate - ISO date string
     * @returns {string} Formatted date
     */
    function formatDateYMD(isoDate) {
      const date = new Date(isoDate);
      const year = date.getUTCFullYear();
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const day = String(date.getUTCDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    /**
     * Creates SEO-friendly match slug from team names and date
     * @param {string} homeTeam - Home team name
     * @param {string} awayTeam - Away team name
     * @param {string} utcKickoff - UTC kickoff time
     * @returns {string} Match slug for URLs
     */
    function createMatchSlug(homeTeam, awayTeam, utcKickoff) {
      return `${slugify(homeTeam)}-vs-${slugify(awayTeam)}-${formatDateYMD(utcKickoff)}`;
    }
    /** Team name aliases for compact display */
    const TEAM_ALIASES = {
      'Wolverhampton Wanderers': 'Wolves',
      'Brighton & Hove Albion': 'Brighton',
      'Manchester United': 'Man Utd',
      'Manchester City': 'Man City',
      'Tottenham Hotspur': 'Spurs',
      'West Ham United': 'West Ham',
      'Newcastle United': 'Newcastle',
      'Nottingham Forest': 'Nottm Forest',
      'Sheffield United': 'Sheff Utd',
      'Leicester City': 'Leicester',
      'Leeds United': 'Leeds',
      'West Bromwich Albion': 'West Brom'
    };
    
    /**
     * Gets team alias for compact display
     * @param {string} teamName - Full team name
     * @returns {string} Alias or original name
     */
    const getTeamAlias = (teamName) => TEAM_ALIASES[teamName] || teamName;

    // ===========================================
    // DATE & TIME UTILITIES
    // ===========================================
    
    /**
     * Robust UTC date parser handling multiple input formats
     * @param {string|Date} dateInput - Date input in various formats
     * @returns {Date} Parsed Date object
     */
    function parseUtcDate(dateInput) {
      if (dateInput instanceof Date) return dateInput;
      if (typeof dateInput !== 'string') return new Date(dateInput);
      
      if (dateInput.includes('T')) {
        // ISO format with timezone info
        if (dateInput.endsWith('Z') || dateInput.includes('+') || dateInput.includes('-')) {
          return new Date(dateInput);
        } else {
          // No timezone info, assume UTC
          return new Date(dateInput + 'Z');
        }
      }
      
      // Normalize space-separated format and handle timezone suffixes
      const normalized = dateInput.replace(' ', 'T').replace(/(\+00(?::?00)?)$/, 'Z');
      if (!normalized.endsWith('Z') && !normalized.includes('+') && !normalized.includes('-')) {
        return new Date(normalized + 'Z');
      }
      return new Date(normalized);
    }

    /**
     * Creates timezone-specific formatters for day and time display
     * @param {string} timezone - IANA timezone identifier
     * @returns {Object} Object with dayKey and timeKey formatters
     */
    function createTimezoneFormatters(timezone) {
      return {
        dayKey: new Intl.DateTimeFormat('en-CA', { 
          timeZone: timezone, 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit' 
        }),
        timeKey: new Intl.DateTimeFormat('en-GB', { 
          timeZone: timezone, 
          hour: '2-digit', 
          minute: '2-digit', 
          hour12: false 
        })
      };
    }
    
    /**
     * Groups fixtures by day and time within each day
     * @param {Array} fixtures - Array of fixture objects
     * @param {string} timezone - IANA timezone identifier
     * @returns {Map} Map of day -> Map of time -> fixtures array
     */
    function groupFixturesByDayAndTime(fixtures, timezone = DEFAULT_TZ) {
      const { dayKey, timeKey } = createTimezoneFormatters(timezone);
      const byDay = new Map();
      
      for (const fixture of fixtures) {
        const date = parseUtcDate(fixture.utc_kickoff);
        const dayKey_formatted = dayKey.format(date);
        const timeKey_formatted = timeKey.format(date);
        
        if (!byDay.has(dayKey_formatted)) {
          byDay.set(dayKey_formatted, new Map());
        }
        
        const byTime = byDay.get(dayKey_formatted);
        if (!byTime.has(timeKey_formatted)) {
          byTime.set(timeKey_formatted, []);
        }
        
        byTime.get(timeKey_formatted).push(fixture);
      }
      
      return byDay; // Map(dayKey -> Map(timeKey -> fixtures[]))
    }

    // ===========================================
    // API CONFIGURATION
    // ===========================================
    
    /** Supabase API configuration */
    const SUPABASE_CONFIG = {
      url: 'https://nkfuzkrazehjivzmdrvt.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rZnV6a3JhemVoaml2em1kcnZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNjI5MzAsImV4cCI6MjA3MjgzODkzMH0.CNW1EUtcC4JWfDy-WzOIVDfv7rnXzsz1qqQyRTZVyXU'
    };
    
    /** HTTP headers for Supabase API requests */
    const API_HEADERS = { 
      apikey: SUPABASE_CONFIG.anonKey, 
      Authorization: `Bearer ${SUPABASE_CONFIG.anonKey}` 
    };

    /** API endpoint paths */
    const API_ENDPOINTS = {
      fixturesList: '/rest/v1/fixtures_with_teams',
      fixtureOne: '/rest/v1/fixtures_with_teams', 
      teams: '/rest/v1/teams',
      broadcasts: '/rest/v1/broadcasts', // Simplified for clean DB
      providers: '/rest/v1/providers',
      affiliate: '/rest/v1/affiliate_destinations'
    };
    
    /** Common query parameters */
    const QUERY_PARAMS = {
      orderByKickoff: 'order=utc_kickoff.asc',
      limit: 2000 // Generous limit for fixture lists
    };
    
    /**
     * Makes authenticated API request to Supabase
     * @param {string} endpoint - API endpoint path
     * @returns {Promise<any>} API response data
     */
    async function apiRequest(endpoint) {
      console.log('API Request:', `${SUPABASE_CONFIG.url}${endpoint}`);
      
      const response = await fetch(`${SUPABASE_CONFIG.url}${endpoint}`, { 
        headers: API_HEADERS 
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API Error:', response.status, response.statusText, errorText);
        throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
      }
      
      const data = await response.json();
      console.log('API Response:', data?.length || 0, 'records');
      return data;
    }

   // ---- History API Router (clean URLs under /football) ----
const routes = { 
  "/": homeView, 
  "/fixtures": fixturesView, 
  "/table": tableView, 
  "/match": matchView, 
  "/clubs": clubsIndexView, 
  "/club": clubPageView, 
  "/about": aboutView,
  "/tv-guide": tvGuideView,
  "/how-to-watch-premier-league": howToWatchView,
  "/fixtures-this-weekend": weekendFixturesView,
  "/how-to-watch": teamViewingGuideView,
  "/debug": debugDataView,
};
const APP_BASE = '/football';
const DEV_HASH = (location.hostname === '127.0.0.1' || location.hostname === 'localhost') && location.port;

function parseRoute(){
  // Simple hash-based routing: #/fixtures, #/premier-league/clubs, #/matches/123
  let hash = location.hash.slice(1) || '/'; // Remove # and default to /
  
  // Extract query parameters from hash
  const [path, queryString] = hash.split('?');
  const params = new URLSearchParams(queryString || '');
  
  // Parse path: /premier-league/fixtures -> competition: premier-league, routePath: /fixtures  
  const parts = path.split('/').filter(Boolean);
  let competition = 'premier-league'; // default
  let routePath = path;
  
  if (parts.length >= 1 && COMPETITIONS[parts[0]]) {
    competition = parts[0];
    routePath = '/' + parts.slice(1).join('/');
    if (routePath === '/') routePath = '/';
  }
  
  // Handle match URLs: /matches/123-team-vs-team -> extract ID and set as param
  if (routePath.startsWith('/matches/')) {
    const matchPart = routePath.split('/')[2];
    if (matchPart) {
      const m = /^(\d+)/.exec(matchPart);
      if (m) {
        params.set('id', m[1]);
        routePath = '/match';
      }
    }
  }
  
  // Handle club URLs: /clubs/arsenal -> set slug param
  if (routePath.startsWith('/clubs/')) {
    const clubSlug = routePath.split('/')[2];
    if (clubSlug) {
      params.set('slug', clubSlug);
      routePath = '/club';
    }
  }
  
  return { path: routePath, params, competition };
}

function navigate(to){
  // Simple hash navigation - convert any URL to hash format
  let hashPath = to;
  
  // Convert old /football/... URLs to hash format
  if (hashPath.startsWith('/football/')) {
    hashPath = hashPath.replace('/football', '');
  }
  
  // Ensure it starts with /
  if (!hashPath.startsWith('/')) {
    hashPath = '/' + hashPath;
  }
  
  // Set the hash (this will trigger hashchange event)
  location.hash = hashPath;
}

// Simple click interceptor for hash navigation
document.addEventListener('click', (e)=>{
  const a = e.target.closest('a');
  if (!a) return;
  const href = a.getAttribute('href') || '';
  
  // Skip external links, special keys, and blank targets
  if (href.startsWith('http') || href.startsWith('mailto:') || 
      e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || 
      a.target === '_blank') return;
  
  // Skip if it's already a hash link that matches our format
  if (href.startsWith('#/')) return;
  
  // Intercept internal links
  if (href.startsWith('/football/') || href.startsWith('/')) {
    e.preventDefault();
    navigate(href);
  }
});

// Handle hash changes (our main routing mechanism)
window.addEventListener('hashchange', () => {
  if (window.plausible) { try { window.plausible('pageview'); } catch(e){} }
  render();
});

// Initialize with default hash if none exists
if (!location.hash) {
  location.hash = '/';
}

// Plausible Analytics Event Tracking
function trackAffiliateClick(event) {
  if (window.plausible) {
    try {
      window.plausible('Affiliate Click', {
        props: {
          type: 'watch_options',
          page: window.location.pathname
        }
      });
    } catch(e) {
      console.log('Plausible tracking error:', e);
    }
  }
}

function trackFixtureView(fixtureId, homeTeam, awayTeam) {
  if (window.plausible) {
    try {
      window.plausible('Fixture View', {
        props: {
          fixture_id: fixtureId,
          match: `${homeTeam} vs ${awayTeam}`,
          page: window.location.pathname
        }
      });
    } catch(e) {
      console.log('Plausible tracking error:', e);
    }
  }
}

function trackTeamPageView(teamName) {
  if (window.plausible) {
    try {
      window.plausible('Team Page View', {
        props: {
          team: teamName,
          page: window.location.pathname
        }
      });
    } catch(e) {
      console.log('Plausible tracking error:', e);
    }
  }
}

function trackContentPageView(pageName) {
  if (window.plausible) {
    try {
      window.plausible('Content Page View', {
        props: {
          content_type: pageName,
          page: window.location.pathname
        }
      });
    } catch(e) {
      console.log('Plausible tracking error:', e);
    }
  }
}

// Expose functions to global scope for use in inline scripts
window.COMPETITIONS = COMPETITIONS;
window.getCompetition = getCompetition;
window.getActiveCompetitions = getActiveCompetitions;
window.parseRoute = parseRoute;
window.updateNavigationLinks = updateNavigationLinks;
window.updateCompetitionStyling = updateCompetitionStyling;
window.navigate = navigate;

// kick off first render
render();

function setActiveNav(){
  const isFootball = location.pathname.startsWith('/football');
  const pill = document.getElementById('nav-sport-football');
  if (pill) pill.setAttribute('aria-current', isFootball ? 'page' : 'false');
}

    function parseHash(){
  // Back-compat shim: we now route by pathname
  return parseRoute();
}

    // SEO meta tag updater
    function updateMetaTags(title, description, ogData = {}) {
      document.getElementById('page-title').textContent = title;
      document.getElementById('meta-description').setAttribute('content', description);
      document.getElementById('og-title').setAttribute('content', ogData.title || title);
      document.getElementById('og-description').setAttribute('content', ogData.description || description);
      document.getElementById('twitter-title').setAttribute('content', ogData.twitterTitle || title);
      document.getElementById('twitter-description').setAttribute('content', ogData.twitterDescription || description);
    }

    async function render(){
      const { path, params, competition } = parseRoute();
      setCanonical(location.origin + location.pathname);
      setActiveNav(path);
      // updateNavigationLinks(competition); // DISABLED - nav links are set in renderFootballSubnav()
      updateCompetitionStyling(competition); // Update competition-specific styling
      
      // Dynamic SEO meta tags based on route
      const competitionName = competition.name || 'Premier League';
      const competitionSlug = competition.slug || 'premier-league';
      
      // Update canonical URL to use clean paths
      const canonicalPath = path === '/' ? `/football/${competitionSlug}` : path;
      setCanonical(`${location.origin}${canonicalPath}`);
      
      if (path.includes('/fixtures')) {
        updateMetaTags(
          `${competitionName} Fixtures & TV Schedule UK | fixtures.app`,
          `Complete ${competitionName} fixture list with UK TV channels. Sky Sports, TNT Sports, BBC coverage times.`,
          {
            twitterTitle: `${competitionName} TV Fixtures UK`,
            twitterDescription: `Find which channel shows every ${competitionName} match`
          }
        );
      } else if (path.includes('/matches/')) {
        const matchId = path.split('/matches/')[1];
        updateMetaTags(
          `Match ${matchId} TV Coverage | ${competitionName} | fixtures.app`,
          `Find which UK broadcaster shows this ${competitionName} match. Sky Sports, TNT Sports, BBC coverage details.`,
          {
            twitterTitle: `${competitionName} Match TV Coverage`,
            twitterDescription: `UK TV broadcast details for this match`
          }
        );
      } else if (path.includes('/teams/')) {
        const teamSlug = path.split('/teams/')[1];
        const teamName = teamSlug ? teamSlug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Team';
        updateMetaTags(
          `${teamName} TV Fixtures | ${competitionName} | fixtures.app`,
          `${teamName} ${competitionName} fixtures and UK TV schedule. Find which broadcaster shows every ${teamName} match.`,
          {
            twitterTitle: `${teamName} TV Fixtures`,
            twitterDescription: `${teamName} broadcast schedule for UK viewers`
          }
        );
      } else {
        updateMetaTags(
          `${competitionName} TV Schedule UK | fixtures.app`,
          `Find which broadcaster shows every ${competitionName} match - Sky Sports, TNT Sports, BBC. Live fixtures, times & channels.`,
          {
            twitterTitle: `${competitionName} TV Schedule UK`,
            twitterDescription: `Premier League broadcast guide for UK viewers`
          }
        );
      }
      const view = routes[path] || homeView;
      setStatus("loading…");
      try { await view(params, competition); } catch(e){
        console.error(e);
        document.getElementById("app").innerHTML = `<p class=\"muted\">${e.message}</p>`;
      } finally { setStatus(""); }
    }
    function setStatus(txt){ document.getElementById("status").textContent = txt; }

function renderFootballSubnav(competition){
  const compSlug = competition.slug || 'premier-league';
  const currentHash = location.hash.slice(1) || '/';
  const isFixtures = currentHash.includes('/fixtures');
  const isClubs    = currentHash.includes('/clubs') && !currentHash.includes('/clubs/');
  const isClub     = currentHash.includes('/clubs/');
  const isTable    = currentHash.includes('/table');
  const pageLabel  = isClub ? 'Club' : isFixtures ? 'Fixtures' : isClubs ? 'Clubs' : isTable ? 'Table' : 'Overview';

  const link = (href,label,active) => `<a class="tab ${active?'active':''}" ${active?'aria-current="page"':''} href="#/${compSlug}${href}">${label}</a>`;
  const overviewHref = '';

  const tabs = `
    <nav class="tabs" aria-label="Section navigation">
      ${link(overviewHref, 'Overview', pageLabel==='Overview')}
      ${link('/fixtures', 'Fixtures', pageLabel==='Fixtures')}
      ${link('/clubs', 'Clubs', pageLabel==='Clubs' || pageLabel==='Club')}
      ${link('/table', 'Table', pageLabel==='Table')}
    </nav>`;

  const crumbs = `
    <nav class="crumbs" aria-label="Breadcrumb">
      <span>Football</span> · <span>${competition.name}</span>${pageLabel!=='Overview'?` · <span>${pageLabel}</span>`:''}
    </nav>`;

  return `
    <div class="subnav subnav-bar" role="navigation" aria-label="Sport context">
      <div class="subnav-inner">
        ${crumbs}
        ${tabs}
      </div>
    </div>`;
}

// ---- Views ----
    async function homeView(params, competitionSlug = 'premier-league'){
      const app = document.getElementById("app");
      const { params: legacyParams } = parseHash();
      const actualParams = params || legacyParams;
      const tzParam = actualParams.get('tz');
      const TZ = tzParam || DEFAULT_TZ;
      
      // Get competition configuration
      const competition = getCompetition(competitionSlug);
      const subnav = renderFootballSubnav(competition);

      // Load upcoming fixtures (same source as fixtures page)
      const nowIso = new Date().toISOString();
      console.log('Loading fixtures for competition:', competition.name, 'ID:', competition.id);
      
      let rows;
      try {
        rows = await loadFixtures(competition.id, true);
      } catch (error) {
        console.error('Failed to load fixtures:', error);
        app.innerHTML = `<div class="card"><p class="muted">Unable to load fixtures for ${competition.name}. Please try refreshing.</p><p><a href="#/premier-league">Try Premier League</a></p></div>`;
        return;
      }
      
      const fixtures = (rows||[]).map(r => ({
        id: r.id,
        utc_kickoff: r.utc_kickoff,
        matchday: r.matchday ?? null,
        home: r.home_team,
        away: r.away_team,
        home_badge: r.home_crest || null,
        away_badge: r.away_crest || null,
        competition_id: r.competition_id,
        competition_name: r.competition_name || 'Premier League', // fallback for existing data
      })).filter(f => f.home && f.away && !Number.isNaN(Date.parse(f.utc_kickoff)));

      if (!fixtures.length){
        app.innerHTML = `<p class="muted">No upcoming fixtures.</p>`;
        return;
      }

      // Determine the next matchweek number among upcoming fixtures
      const upcomingMw = fixtures
        .map(f => f.matchday)
        .filter(n => Number.isInteger(n))
        .sort((a,b)=>a-b)[0] ?? null;

      const subset = upcomingMw == null ? fixtures.slice(0, Math.min(10, fixtures.length))
                                        : fixtures.filter(f => f.matchday === upcomingMw);

      // Preload broadcasts for those fixtures only
      let bmap = {};
      const ids = subset.map(f => f.id);
      if (ids.length) {
        const qs = ids.join(',');
        try {
          const brows = await jget(`${API_ENDPOINTS.broadcasts}?fixture_id=in.(${qs})`);
          for (const b of (brows || [])){
            if (!bmap[b.fixture_id]) bmap[b.fixture_id] = [];
            bmap[b.fixture_id].push(b);
          }
        } catch (e) { console.error("Failed to load broadcasts", e); }
      }

      const prettyDay = new Intl.DateTimeFormat(LOCALE, { weekday:'long', day:'numeric', month:'short', timeZone: TZ });
      const prettyDate = new Intl.DateTimeFormat(LOCALE, { day:'numeric', month:'short', timeZone: TZ });

      const renderCard = (f) => {
        const hasB = (bmap[f.id] || []).length > 0;
        const idSlug = f.id ? `${f.id}-${createMatchSlug(f.home, f.away, f.utc_kickoff)}` : createMatchSlug(f.home, f.away, f.utc_kickoff);
        const href = f.id ? `#/matches/${idSlug}` : '#';
        console.log('Generating match link:', { id: f.id, slug: idSlug, href, fixture: f });
        
        // Get competition info for badge
        const comp = f.competition_id ? Object.values(COMPETITIONS).find(c => c.id === f.competition_id) : getCompetition('premier-league');
        const compBadge = `<span class="comp-badge" style="font-size:11px;background:${comp.colors.primary};color:#fff;padding:2px 6px;border-radius:10px;margin-left:6px;">${comp.shortName}</span>`;
        
        const homeRow = `<div class="team-row">${f.home_badge ? `<img class=\"crest\" alt=\"${f.home} badge\" src=\"${f.home_badge}\">` : ''}<strong>${getTeamAlias(f.home)}</strong></div>`;
        const awayRow = `<div class="team-row">${f.away_badge ? `<img class=\"crest\" alt=\"${f.away} badge\" src=\"${f.away_badge}\">` : ''}<strong>${getTeamAlias(f.away)}</strong></div>`;
        return `
          <a class="cardlink" href="${href}">
            <div class="card">
              <div class="row">
                <div class="left">
                  <div class="teams-stack">${homeRow}${awayRow}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  ${compBadge}
                  <span class="${hasB ? 'btn small right' : 'btn small right disabled broadcast-status'}" data-has-broadcast="${hasB}">${hasB ? 'Watch options' : 'Broadcast TBC'}</span>
                </div>
              </div>
            </div>
          </a>`;
      };

      // Build grouped sections: by day, then by HH:mm (one time label per group)
      const byDay = groupFixturesByDayAndTime(subset, TZ);
      const { dayKey: currentDayKey } = createTimezoneFormatters(TZ);
      const daySections = Array.from(byDay.entries())
        .sort(([a],[b])=>a.localeCompare(b))
        .map(([dayKey, byTime]) => {
          const sample = subset.find(f => currentDayKey.format(parseUtcDate(f.utc_kickoff)) === dayKey);
          const dayLabel = sample ? prettyDay.format(parseUtcDate(sample.utc_kickoff)) : dayKey;
          const timeBlocks = Array.from(byTime.entries())
            .sort(([a],[b])=>a.localeCompare(b))
            .map(([hhmm, list]) => `<div class="time-group"><span class="time-dot"></span><strong>${hhmm}</strong></div>` + list.map(renderCard).join(''))
            .join('');
          return `<h3 class="muted">${dayLabel}</h3>${timeBlocks}`;
        }).join('');

      const dates = subset.map(f => parseUtcDate(f.utc_kickoff)).sort((a,b)=>a-b);
      const first = prettyDate.format(dates[0]);
      const last  = prettyDate.format(dates[dates.length-1]);
      const range = first === last ? first : `${first} – ${last}`;
      const pill  = (upcomingMw != null) ? `MW ${upcomingMw}` : range;

      app.innerHTML = `
        ${subnav}
        <section class="section mw featured">
          <div class="mw-head">
            <h2>Upcoming matches</h2>
            <span class="pill">${pill}</span>
          </div>
          ${daySections}
        </section>
        <a class="floater" href="#/${competition.slug}/fixtures" aria-label="See all fixtures">See all fixtures • scroll for more ↓</a>
      `;
    }
// ---- Debug Data View (safe version) ----
async function debugDataView(params, competitionSlug = 'premier-league') {
  trackContentPageView('debug');
  const app = document.getElementById('app');

  const competition = getCompetition(competitionSlug);
  const subnav = renderFootballSubnav(competition);
  const nowIso = new Date().toISOString();

  try {
    // Keep queries light so this page always renders
    const teams = await jget(`${API_ENDPOINTS.teams}?select=id,name,slug,competition_id&order=name.asc&limit=50`);
    // Use the improved loadFixtures function to get only valid fixtures
    const allFixtures = await loadFixtures(competition.id, true);
    const fixtures = (allFixtures || []).slice(0, 10); // Limit to 10 for debug display

    const rows = fixtures.map(f => {
      const d = new Date(f.utc_kickoff);
      const when = new Intl.DateTimeFormat(LOCALE, { dateStyle: 'medium', timeStyle: 'short', timeZone: DEFAULT_TZ }).format(d);
      return `<tr>
        <td>${f.id}</td>
        <td>${when}</td>
        <td>${f.home_team || f.home}</td>
        <td>${f.away_team || f.away}</td>
      </tr>`;
    }).join('');

    app.innerHTML = subnav + `
      <section class="section">
        <h2>🔍 Database Debug Inspector</h2>
        <p class="muted">Lightweight checks to verify API and data wiring.</p>

        <div class="card"><strong>Competition:</strong> ${competition.name} (ID ${competition.id})</div>
        <div class="card"><strong>Teams loaded:</strong> ${(teams || []).length}</div>
        <div class="card">
          <h3 style="margin:0 0 6px">Upcoming fixtures (first 10)</h3>
          <div style="overflow:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr><th>ID</th><th>Kickoff</th><th>Home</th><th>Away</th></tr>
              </thead>
              <tbody>${rows || ''}</tbody>
            </table>
          </div>
        </div>
        <p><a href="#/">← Back to Home</a></p>
      </section>
    `;
  } catch (error) {
    console.error('Error loading debug view:', error);
    app.innerHTML = subnav + `
      <div class="card">
        <h2>Debug Data Error</h2>
        <p class="muted">${error.message}</p>
        <p><a href="#/">← Back to Home</a></p>
      </div>
    `;
  }
}

    async function fixturesView(params, competitionSlug = 'premier-league'){
      const app = document.getElementById("app");
      const { params: legacyParams } = parseHash();
      const actualParams = params || legacyParams;
      const tzParam = actualParams.get('tz');
      const TZ = tzParam || DEFAULT_TZ;
      const teamFilter = (actualParams.get('team')||'').toLowerCase();
      const compFilter = (actualParams.get('comp')||'pl');
      const mwParam = (actualParams.get('mw')||'');
      
      // Get competition configuration
      const competition = getCompetition(competitionSlug);
      const subnav = renderFootballSubnav(competition);

      // Load fixtures
      const nowIso = new Date().toISOString();
      console.log('Loading fixtures for competition:', competition.name, 'ID:', competition.id);
      
      let rows;
      try {
        rows = await loadFixtures(competition.id, true);
      } catch (error) {
        console.error('Failed to load fixtures:', error);
        app.innerHTML = `<div class="card"><p class="muted">Unable to load fixtures for ${competition.name}. Please try refreshing.</p><p><a href="#/premier-league">Try Premier League</a> | <a href="#/">← Home</a></p></div>`;
        return;
      }
      
      const fixtures = (rows||[]).map(r => ({
        id: r.id,
        utc_kickoff: r.utc_kickoff,
        matchday: r.matchday ?? null,
        home: r.home_team,
        away: r.away_team,
        home_badge: r.home_crest || null,
        away_badge: r.away_crest || null,
      })).filter(f => f.home && f.away && !Number.isNaN(Date.parse(f.utc_kickoff)));

      // Load teams for crest selector using robust loader
      const teamsRows = await loadTeams(competition.id, true);
      const teamByName = Object.fromEntries((teamsRows||[]).map(t=>[t.name, t]));

      const teamSet = Array.from(new Set(fixtures.flatMap(f=>[f.home,f.away]))).sort((a,b)=>a.localeCompare(b));
      const mwSet = Array.from(new Set(fixtures.map(f => f.matchday).filter(n => Number.isInteger(n)))).sort((a,b)=>a-b);

      // Crest selector row
      const crestSelector = `
        <div class="crest-row" id="crestRow">
          <button class="crest-btn" data-team="" aria-pressed="${teamFilter===''?'true':'false'}"><span>All clubs</span></button>
          ${teamSet.map(name=>{
            const t = teamByName[name];
            const pressed = (teamFilter && name.toLowerCase()===teamFilter) ? 'true' : 'false';
            const img = t?.crest_url ? `<img class="crest" alt="${name} badge" src="${t.crest_url}">` : '';
            return `<button class="crest-btn" data-team="${name}" aria-pressed="${pressed}">${img}<span>${name}</span></button>`;
          }).join('')}
        </div>`;

      // Filters side rail
      const filterHTML = `
        <div class="layout">
          <aside class="filters-rail">
            <h3>Filter</h3>
            <div class="filters">
              <label>Competition
                <select id="compFilter">
                  <option value="pl">Premier League</option>
                </select>
              </label>
              <label>Matchweek
                <select id="mwFilter">
                  <option value="">All</option>
                  ${mwSet.map(n=>`<option value="${n}">MW ${n}</option>`).join('')}
                </select>
              </label>
              <label>Watching from
                <select id="tzFilter">
                  ${TIMEZONE_OPTIONS.map(o=>`<option value="${o.tz}">${o.label}</option>`).join('')}
                </select>
              </label>
              <div style="margin-top:10px"><small class="muted">Tip: use the crest buttons to filter by club.</small></div>
            </div>
          </aside>
          <main id="listArea" class="main-col"></main>
        </div>`;

      // Apply basic filters
      const baseFiltered = fixtures.filter(f => {
        const teamOK = teamFilter ? (f.home.toLowerCase()===teamFilter || f.away.toLowerCase()===teamFilter) : true;
        const compOK = (compFilter === 'pl');
        const mwOK = mwParam ? String(f.matchday||'') === mwParam : true;
        return teamOK && compOK && mwOK;
      });

      // Batch-load broadcasts (optional; safe if empty)
      let bmap = {};
      const ids = baseFiltered.map(f => f.id);
      if (ids.length) {
        const qs = ids.join(',');
        try {
          const brows = await jget(`${API_ENDPOINTS.broadcasts}?fixture_id=in.(${qs})`);
          for (const b of (brows || [])){
            if (!bmap[b.fixture_id]) bmap[b.fixture_id] = [];
            bmap[b.fixture_id].push(b);
          }
        } catch (e) { console.error("Failed to load broadcasts", e); }
      }

      // Render helpers
      const timeOnly   = new Intl.DateTimeFormat(LOCALE, { timeStyle: 'short', timeZone: TZ });
      const dateOnly   = new Intl.DateTimeFormat(LOCALE, { weekday:'short', day:'numeric', month:'short', timeZone: TZ });
      const prettyDay  = new Intl.DateTimeFormat(LOCALE, { weekday:'long', day:'numeric', month:'short', timeZone: TZ });
      const prettyDate = new Intl.DateTimeFormat(LOCALE, { day:'numeric', month:'short', timeZone: TZ });

      const renderCard = (f, withTime=false) => {
        const kickoffTime = timeOnly.format(parseUtcDate(f.utc_kickoff));
        const hasB = (bmap[f.id] || []).length > 0;
        const idSlug = f.id ? `${f.id}-${createMatchSlug(f.home, f.away, f.utc_kickoff)}` : createMatchSlug(f.home, f.away, f.utc_kickoff);
        const href = f.id ? `#/matches/${idSlug}` : '#';
        const homeRow = `<div class="team-row">${f.home_badge ? `<img class=\"crest\" alt=\"${f.home} badge\" src=\"${f.home_badge}\">` : ''}<strong>${getTeamAlias(f.home)}</strong></div>`;
        const awayRow = `<div class="team-row">${f.away_badge ? `<img class=\"crest\" alt=\"${f.away} badge\" src=\"${f.away_badge}\">` : ''}<strong>${getTeamAlias(f.away)}</strong></div>`;
        return `
          <a class="cardlink" href="${href}">
            <div class="card">
              <div class="row">
                <div class="left">
                  <div class="teams-stack">${homeRow}${awayRow}</div>
                  ${withTime ? `<div class="muted">${dateOnly.format(parseUtcDate(f.utc_kickoff))} · ${kickoffTime}</div>` : ''}
                </div>
                <div>
                  <span class="${hasB ? 'btn small right' : 'btn small right disabled broadcast-status'}" data-has-broadcast="${hasB}">${hasB ? 'Watch options' : 'Broadcast TBC'}</span>
                </div>
              </div>
            </div>
          </a>`;
      };

      function renderList(items){
        const listArea = document.getElementById('listArea');
        if (!items.length){ listArea.innerHTML = crestSelector + `<p class="muted">No upcoming fixtures.</p>`; wireCrestRow(); return; }
        if (teamFilter){
          // Per-fixture cards when a club is selected
          const cards = items.map(f=> renderCard(f, true)).join('');
          listArea.innerHTML = crestSelector + cards;
          wireCrestRow();
          return;
        }
        // Otherwise: grouped by MW, then by day and kickoff time (time label once)
        const groups = new Map();
        for (const f of items){ const mw = f.matchday ?? 0; if (!groups.has(mw)) groups.set(mw, []); groups.get(mw).push(f); }
        const { dayKey: fixturesDayKey } = createTimezoneFormatters(TZ);
        const sections = Array.from(groups.entries()).sort(([a],[b])=> (a||0)-(b||0)).map(([mw, list])=>{
          const byDay = groupFixturesByDayAndTime(list, TZ);
          const dates = list.map(f => parseUtcDate(f.utc_kickoff)).sort((a,b)=>a-b);
          const range = `${prettyDate.format(dates[0])}${dates.length>1?` – ${prettyDate.format(dates[dates.length-1])}`:''}`;
          const inner = Array.from(byDay.entries()).sort(([a],[b])=>a.localeCompare(b)).map(([dayKey, byTime])=>{
            const sample = list.find(x => fixturesDayKey.format(parseUtcDate(x.utc_kickoff)) === dayKey);
            const dayLabel = sample ? prettyDay.format(parseUtcDate(sample.utc_kickoff)) : dayKey;
            const timeBlocks = Array.from(byTime.entries()).sort(([a],[b])=>a.localeCompare(b)).map(([hhmm, li])=>{
              const cards = li.map(f=> renderCard(f, false)).join('');
              return `<div class="time-group"><span class="time-dot"></span><strong>${hhmm}</strong></div>` + cards;
            }).join('');
            return `<h3 class="muted">${dayLabel}</h3>${timeBlocks}`;
          }).join('');
          const mwLabel = mw>0?`Matchweek ${mw}`:'Upcoming matches';
          const pill = mw>0?`MW ${mw}`:range;
          return `<section class="section mw"><div class="mw-head"><h2>${mwLabel}</h2><span class="pill">${pill}</span></div>${inner}</section>`;
        }).join('');
        listArea.innerHTML = crestSelector + sections;
        wireCrestRow();
      }

      // Initial render
      app.innerHTML = subnav + filterHTML;
      renderList(baseFiltered);
      // setPrettyUrl('/football/fixtures');

      // Wire filters → URL params
      const compSel = document.getElementById('compFilter');
      const mwSel = document.getElementById('mwFilter');
      const tzSel = document.getElementById('tzFilter');
      function updateParam(k,v){
        const url = new URL(location.href);
        if (v) url.searchParams.set(k, v); else url.searchParams.delete(k);
        history.replaceState(null, '', url.pathname + (url.search ? url.search : ''));
        render();
      }
      if (compSel) compSel.value = compFilter;
      if (mwSel) mwSel.value = mwParam;
      if (tzSel) tzSel.value = TZ;
      compSel?.addEventListener('change', e=> updateParam('comp', e.target.value));
      mwSel?.addEventListener('change', e=> updateParam('mw', e.target.value));
      tzSel?.addEventListener('change', e=> updateParam('tz', e.target.value));

      // Crest selector interactions
      function wireCrestRow(){
        const row = document.getElementById('crestRow');
        if (!row) return;
        for (const btn of row.querySelectorAll('.crest-btn')){
          btn.addEventListener('click', ()=>{
            const name = btn.getAttribute('data-team') || '';
            updateParam('team', name.toLowerCase());
          });
        }
      }
    }

    async function tableView(params, competitionSlug = 'premier-league'){
      const app = document.getElementById('app');

      // Get competition configuration
      const competition = getCompetition(competitionSlug);
      const subnav = renderFootballSubnav(competition);

      try {
        // Load teams only (no standings yet) and sort by name
        const teams = await loadTeams(competition.id, true);
        const list = (teams || []).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));

        const thead = `<tr>
          <th style="text-align:left">Pos</th>
          <th style="text-align:left">Club</th>
          <th>MP</th><th>W</th><th>D</th><th>L</th>
          <th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
        </tr>`;

        const trs = list.map((t, i) => `
          <tr>
            <td>${i + 1}</td>
            <td style="text-align:left;display:flex;align-items:center;gap:8px">
              ${t.crest_url ? `<img class="crest" alt="${t.name} badge" src="${t.crest_url}">` : ''}
              <a class="cardlink" href="#/${competition.slug}/clubs/${encodeURIComponent(t.slug)}" style="display:inline">${t.name}</a>
            </td>
            <td>–</td><td>–</td><td>–</td><td>–</td>
            <td>–</td><td>–</td><td>–</td><td><strong>–</strong></td>
          </tr>`).join('');

        app.innerHTML = subnav + `
          <div class="card">
            <div class="section">
              <h2 style="margin:0 0 6px">${competition.name} table</h2>
              <div class="muted">Standings will auto-update once data is connected.</div>
              <div style="overflow:auto;margin-top:8px">
                <table style="width:100%;border-collapse:collapse">
                  <thead>${thead}</thead>
                  <tbody>${trs || ''}</tbody>
                </table>
              </div>
            </div>
          </div>`;
      } catch (e) {
        console.error('Table view error:', e);
        app.innerHTML = subnav + `<p class="muted">Unable to load clubs for ${competition.name} yet.</p>`;
      }
    }

    async function matchView(params, competitionSlug = 'premier-league'){
      const app = document.getElementById("app");
      const id = params.get("id");
      if (!id){ app.innerHTML = `<p class="muted">Missing match ID. <a href="#/">Go back</a></p>`; return; }
      
      // Get competition configuration
      const competition = getCompetition(competitionSlug);
      
      // Validate ID is a number
      if (!/^\d+$/.test(id)) {
        app.innerHTML = `<p class="muted">Invalid match ID format. <a href="#/">Home</a></p>`;
        return;
      }

      const { params: _p } = parseHash();
      const tzView = _p.get('tz') || DEFAULT_TZ;

      console.log('matchView: Looking for fixture with ID:', id);
      console.log('API endpoint:', `${SUPABASE_CONFIG.url}${API_ENDPOINTS.fixtureOne}?id=eq.${id}`);
      
      let fixture;
      try {
        // Try fixtures_min_v first
        let results = await jget(`${API_ENDPOINTS.fixtureOne}?id=eq.${id}`);
        console.log('API response from fixtures_min_v:', results);
        fixture = results[0];
        
        // If not found, try the main fixtures view
        if (!fixture) {
          console.log('Trying fixtures_with_team_names_v as fallback...');
          results = await jget(`${API_ENDPOINTS.fixturesList}?id=eq.${id}&limit=1`);
          console.log('API response from fixtures_with_team_names_v:', results);
          fixture = results[0];
        }
        
        if (!fixture){ 
          console.log('No fixture found for ID:', id, 'in either view');
          app.innerHTML = `<p class="muted">Fixture not found (ID: ${id}). <a href="#/">Home</a></p>`; 
          return; 
        }
        console.log('Found fixture:', fixture);
      } catch (error) {
        console.error('Error fetching fixture:', error);
        app.innerHTML = `<p class="muted">Error loading fixture: ${error.message}. <a href="#/">Home</a></p>`;
        return;
      }

      // Fetch additional data with error handling
      let teams = [];
      let tById = {};
      let crestById = {};
      let bcasts = [];
      let affiliatesByProv = {};
      
      try {
        teams = await jget(`${API_ENDPOINTS.teams}?id=in.(${[fixture.home_team_id, fixture.away_team_id].join(",")})&select=id,name,slug,crest_url`);
        tById = Object.fromEntries((teams || []).map(t=>[t.id,t.name]));
        crestById = Object.fromEntries((teams || []).map(t=>[t.id,t.crest_url]));
        
        // Verify we have team data for both teams
        if (!tById[fixture.home_team_id] || !tById[fixture.away_team_id]) {
          console.error('Missing team data for fixture:', { fixture, tById });
          app.innerHTML = `<p class="muted">Match data incomplete (missing team information). <a href="#/">Home</a></p>`;
          return;
        }
      } catch (error) {
        console.error('Error fetching team data:', error);
        app.innerHTML = `<p class="muted">Error loading team data: ${error.message}. <a href="#/">Home</a></p>`;
        return;
      }

      try {
        bcasts = await jget(`${API_ENDPOINTS.broadcasts}?fixture_id=eq.${id}`) || [];
        // Fetch provider names to replace the incorrect display_name from the view
        const provIds = [...new Set(bcasts.map(b => b.provider_id))];
        let providersByProvId = {};
        if (provIds.length) {
          const providers = await jget(`/rest/v1/providers?id=in.(${provIds.join(",")})`);
          providersByProvId = Object.fromEntries((providers || []).map(p => [p.id, p.display_name]));
          
          const aff = await jget(`${API_ENDPOINTS.affiliate}?provider_id=in.(${provIds.join(",")})`);
          affiliatesByProv = Object.fromEntries((aff || []).map(a => [a.provider_id, a.affiliate_url]));
        }
        // Fix the provider_display_name with correct data
        bcasts = bcasts.map(b => ({
          ...b,
          provider_display_name: providersByProvId[b.provider_id] || b.provider_display_name || `Provider ${b.provider_id}`
        }));
      } catch (error) {
        console.error('Error fetching broadcast data:', error);
        // Continue with empty broadcast data rather than failing
        bcasts = [];
      }
      const demoFallback = (providerName) => `https://example.com/demo?provider=${encodeURIComponent(providerName)}&fixture=${encodeURIComponent(id)}`;
      const df = new Intl.DateTimeFormat(LOCALE, { dateStyle: "medium", timeStyle: "short", timeZone: tzView });

      app.innerHTML = `
        <a href="#/" class="muted">← Back</a>
        <h1 style=\"margin:8px 0;display:flex;align-items:center;gap:8px\">
          ${crestById[fixture.home_team_id]?`<img class=\"crest\" alt=\"${tById[fixture.home_team_id]} badge\" src=\"${crestById[fixture.home_team_id]}\">`:''}
          ${tById[fixture.home_team_id]} vs ${tById[fixture.away_team_id]}
          ${crestById[fixture.away_team_id]?`<img class=\"crest\" alt=\"${tById[fixture.away_team_id]} badge\" src=\"${crestById[fixture.away_team_id]}\">`:''}
        </h1>
        <div class=\"muted\">${df.format(parseUtcDate(fixture.utc_kickoff))}${fixture.venue? " — "+fixture.venue: ""}</div>
        <div id=\"providers\"></div>`;

      const order = { tv:1, ott:2, radio:3 };
      bcasts.sort((a,b)=> (order[a.stream_type]||9)-(order[b.stream_type]||9));
      const provBox = document.getElementById("providers");
      provBox.innerHTML = bcasts.length ? bcasts.map(b=>{
        const providerName = b.provider_display_name;
        const channel = b.channel_name ? ` — ${b.channel_name}` : "";
        const verify = b.verified ? `✅ Verified ${b.verified_at ?? ""}` : "Unverified";
        const affUrl = affiliatesByProv[b.provider_id] || demoFallback(providerName);
        const showBtn = (b.stream_type !== "radio");
        return `
          <div class=\"card\">
            <div><strong>${providerName}${channel}</strong> <span class=\"muted\">(${b.stream_type})</span></div>
            <div class=\"muted\" style=\"margin-top:4px\">${verify}</div>
            ${showBtn ? `<a class=\"btn\" href=\"${affUrl}\" target=\"_blank\" rel=\"nofollow noopener\">Watch on ${providerName}</a>` : ``}
          </div>`;
      }).join("") : `<div class=\"card\"><span class=\"muted\">No UK broadcaster listed yet.</span></div>`;
    }
    // ---- Clubs and About views ----
    async function clubsIndexView(params, competitionSlug = 'premier-league'){
      const app = document.getElementById('app');
      
      // Get competition configuration
      const competition = getCompetition(competitionSlug);
      const subnav = renderFootballSubnav(competition);
      
      let teams;
      try {
        teams = await loadTeams(competition.id, true);
      } catch (error) {
        console.error('Failed to load teams:', error);
        app.innerHTML = subnav + `<div class="card"><p class="muted">Unable to load clubs for ${competition.name}: ${error.message}</p><p><a href="#/">← Back to Home</a></p></div>`;
        return;
      }
      
      // Handle empty teams gracefully
      if (!teams || teams.length === 0) {
        app.innerHTML = subnav + `<div class="section"><h2 style="margin:0 0 6px">Clubs</h2><div class="muted">${competition.name}</div></div><div class="card"><p class="muted">No clubs available for ${competition.name} yet.</p><p><a href="#/">← Back to Home</a></p></div>`;
        return;
      }
      
      const items = (teams||[]).map(t=>`
        <a class="cardlink" href="#/${competition.slug}/clubs/${encodeURIComponent(t.slug)}">
          <div class="card mini-card club-tile">
            ${t.crest_url?`<img class="crest" alt="${t.name} badge" src="${t.crest_url}">`:''}
            <strong>${getTeamAlias(t.name)}</strong>
          </div>
        </a>`).join('');
      app.innerHTML = subnav + `<div class="section"><h2 style="margin:0 0 6px">Clubs</h2><div class="muted">${competition.name}</div></div><div class="clubs-grid">${items||'<p class="muted">No clubs found.</p>'}</div>`;
    }

    async function clubPageView(params, competitionSlug = 'premier-league'){
      const app = document.getElementById('app');
      const slug = params.get('slug');
      if (!slug){ app.innerHTML = '<p class="muted">Missing ?slug=…</p>'; return; }
      
      // Get competition configuration
      const competition = getCompetition(competitionSlug);
      const subnav = renderFootballSubnav(competition);
      
      // Try to find team with fallbacks
      let team = null;
      try {
        const teams = await loadTeams(competition.id, true);
        team = teams.find(t => t.slug === slug);
      } catch (error) {
        console.error('Failed to load team:', error);
      }
      
      if (!team) { 
        app.innerHTML = subnav + `<div class="card"><p class="muted">Club not found in ${competition.name}.</p><p><a href="#/${competition.slug}/clubs">← Back to Clubs</a></p></div>`; 
        return; 
      }

      // Load upcoming fixtures that include this club using improved filtering
      const allFixtures = await loadFixtures(competition.id, true);
      const fixtures = (allFixtures||[]).map(r => ({
        id: r.id,
        utc_kickoff: r.utc_kickoff,
        matchday: r.matchday ?? null,
        home: r.home_team || r.home,
        away: r.away_team || r.away,
        home_badge: r.home_crest || r.home_badge || null,
        away_badge: r.away_crest || r.away_badge || null,
      })).filter(f => (f.home===team.name || f.away===team.name));
      fixtures.sort((a,b)=> new Date(a.utc_kickoff) - new Date(b.utc_kickoff));

      const LOCALE_TZ = (Intl.DateTimeFormat().resolvedOptions().timeZone) || 'Europe/London';
      const dateOnly = new Intl.DateTimeFormat(LOCALE, { weekday:'short', day:'numeric', month:'short', timeZone: LOCALE_TZ });
      const timeOnly = new Intl.DateTimeFormat(LOCALE, { timeStyle: 'short', timeZone: LOCALE_TZ });

      const renderCard = (f, isFirst=false) => {
        const isHome = (f.home === team.name);
        const opponentName = isHome ? f.away : f.home;
        const opponentBadge = isHome ? f.away_badge : f.home_badge;
        const kickoff = `${dateOnly.format(parseUtcDate(f.utc_kickoff))} · ${timeOnly.format(parseUtcDate(f.utc_kickoff))}`;
        const idSlug = f.id ? `${f.id}-${createMatchSlug(f.home, f.away, f.utc_kickoff)}` : createMatchSlug(f.home, f.away, f.utc_kickoff);
        const href = f.id ? `#/matches/${idSlug}` : '#';
        const opponentRow = `<div class="opponent-row">${opponentBadge ? `<img class=\"crest\" alt=\"${opponentName} badge\" src=\"${opponentBadge}\">` : ''}<strong>${getTeamAlias(opponentName)}</strong></div>`;
        return `
          <div class="club-item ${isHome ? 'align-left' : 'align-right'}">
            <a class="cardlink" href="${href}">
              <div class="card club-opponent ${isFirst ? 'feature-next' : ''}">
                <div class="row">
                  <div class="left">
                    ${opponentRow}
                    <div class="kick">${kickoff}</div>
                  </div>
                  <div>
                    ${isFirst ? '<span class="pill pill-next" style="margin-right:6px">Next</span>' : ''}
                    <span class="pill">${isHome? 'Home' : 'Away'}</span>
                  </div>
                </div>
              </div>
            </a>
          </div>`;
      };

      // Track team page view
      trackTeamPageView(team.name);
      
      const header = `
        <a href="#/${competition.slug}/clubs" class="muted">← Clubs</a>
        <div class="section club-hero"><h2 style="margin:8px 0;display:flex;align-items:center;gap:10px">
          ${team.crest_url?`<img class="crest" alt="${team.name} badge" src="${team.crest_url}">`:''}
          ${team.name}
        </h2></div>`;

      const body = fixtures.length
        ? `<div class="club-feed">${fixtures.map((f,i)=>renderCard(f, i===0)).join('')}</div>`
        : '<p class="muted">No upcoming fixtures.</p>';

      app.innerHTML = subnav + header + body;
    }

    function tvGuideView(){
      trackContentPageView('tv-guide');
      const app = document.getElementById('app');
      app.innerHTML = `
        <article class="content-page">
          <header class="section">
            <h1>Premier League TV Guide UK</h1>
            <p class="intro">Complete guide to watching Premier League matches on UK television and streaming services.</p>
          </header>
          
          <section class="card">
            <h2>UK Broadcasters</h2>
            
            <div class="broadcaster-guide">
              <div class="broadcaster-item">
                <h3>Sky Sports</h3>
                <p><strong>Channels:</strong> Sky Sports Main Event, Sky Sports Premier League</p>
                <p><strong>What they show:</strong> Up to 128 Premier League matches per season including the Saturday 12:30pm kick-off and Monday Night Football.</p>
                <p><strong>How to watch:</strong> Sky TV subscription, NOW TV Sports Pass (£14.99/month), or streaming via Sky Go app.</p>
              </div>
              
              <div class="broadcaster-item">
                <h3>TNT Sports (formerly BT Sport)</h3>
                <p><strong>Channels:</strong> TNT Sports 1, TNT Sports 2, TNT Sports Ultimate</p>
                <p><strong>What they show:</strong> Up to 52 Premier League matches per season including Saturday 5:30pm games and midweek fixtures.</p>
                <p><strong>How to watch:</strong> TNT Sports subscription via BT, Sky, Virgin Media, or Discovery+ Premium (£30.99/month).</p>
              </div>
              
              <div class="broadcaster-item">
                <h3>BBC</h3>
                <p><strong>Channels:</strong> BBC One, BBC iPlayer</p>
                <p><strong>What they show:</strong> Match of the Day highlights every Saturday night and Sunday morning, plus extended highlights on iPlayer.</p>
                <p><strong>How to watch:</strong> Free-to-air television and BBC iPlayer (UK residents only).</p>
              </div>
              
              <div class="broadcaster-item">
                <h3>Amazon Prime Video</h3>
                <p><strong>What they show:</strong> Select Premier League fixtures during festive period (Boxing Day and New Year fixtures).</p>
                <p><strong>How to watch:</strong> Amazon Prime membership (£8.99/month or £95/year).</p>
              </div>
            </div>
          </section>
          
          <section class="card">
            <h2>TV Schedule Pattern</h2>
            <div class="schedule-grid">
              <div class="schedule-item">
                <strong>Saturday 12:30pm</strong><br>
                <span class="muted">Usually Sky Sports Main Event</span>
              </div>
              <div class="schedule-item">
                <strong>Saturday 3:00pm</strong><br>
                <span class="muted">Not televised (3pm blackout)</span>
              </div>
              <div class="schedule-item">
                <strong>Saturday 5:30pm</strong><br>
                <span class="muted">Usually TNT Sports</span>
              </div>
              <div class="schedule-item">
                <strong>Sunday 2:00pm</strong><br>
                <span class="muted">Sky Sports or TNT Sports</span>
              </div>
              <div class="schedule-item">
                <strong>Sunday 4:30pm</strong><br>
                <span class="muted">Sky Sports Premier League</span>
              </div>
              <div class="schedule-item">
                <strong>Monday 8:00pm</strong><br>
                <span class="muted">Sky Sports (Monday Night Football)</span>
              </div>
            </div>
          </section>
          
          <section class="card">
            <h2>How to Find Match Coverage</h2>
            <p>Use our fixtures page to see which broadcaster is showing each Premier League match. We update broadcast information as soon as it's announced by the Premier League and broadcasters.</p>
            <p><strong>Can't find broadcast info?</strong> Some matches aren't announced until closer to the fixture date, especially for games moved for European competition or television scheduling.</p>
            <a href="#/premier-league/fixtures" class="btn">View Current Fixtures</a>
          </section>
        </article>
        
        <style>
          .content-page { max-width: 800px; margin: 0 auto; }
          .intro { font-size: 1.1rem; color: var(--color-muted); margin-bottom: 2rem; }
          .broadcaster-guide { display: grid; gap: 1.5rem; margin: 1rem 0; }
          .broadcaster-item { padding: 1rem 0; border-bottom: 1px solid var(--color-border); }
          .broadcaster-item:last-child { border-bottom: none; }
          .broadcaster-item h3 { margin: 0 0 0.5rem; color: var(--competition-primary); }
          .broadcaster-item p { margin: 0.5rem 0; }
          .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
          .schedule-item { padding: 1rem; background: var(--color-background); border-radius: 8px; text-align: center; }
          @media (max-width: 600px) {
            .schedule-grid { grid-template-columns: 1fr; }
          }
        </style>`;
    }

    function howToWatchView(){
      trackContentPageView('how-to-watch');
      const app = document.getElementById('app');
      app.innerHTML = `
        <article class="content-page">
          <header class="section">
            <h1>How to Watch Premier League in the UK</h1>
            <p class="intro">Everything you need to know about watching Premier League matches legally in the United Kingdom.</p>
          </header>
          
          <section class="card">
            <h2>Quick Start Guide</h2>
            <ol class="how-to-steps">
              <li><strong>Check the fixture list</strong> - Use our fixtures page to see upcoming matches and which broadcaster is showing them.</li>
              <li><strong>Choose your subscription</strong> - Most matches require Sky Sports or TNT Sports subscription.</li>
              <li><strong>Watch highlights for free</strong> - BBC Match of the Day shows extended highlights every weekend.</li>
              <li><strong>Set up your apps</strong> - Download Sky Go, TNT Sports app, or BBC iPlayer for streaming.</li>
            </ol>
          </section>
          
          <section class="card">
            <h2>Subscription Options</h2>
            
            <div class="subscription-options">
              <div class="option-card">
                <h3>Sky Sports Package</h3>
                <div class="price">From £22/month</div>
                <ul>
                  <li>128 Premier League matches per season</li>
                  <li>Saturday 12:30pm games</li>
                  <li>Monday Night Football</li>
                  <li>Sky Sports app included</li>
                </ul>
                <p class="note">Available through Sky TV, Virgin Media, or NOW TV Sports Pass</p>
              </div>
              
              <div class="option-card">
                <h3>TNT Sports</h3>
                <div class="price">From £15/month</div>
                <ul>
                  <li>52 Premier League matches per season</li>
                  <li>Saturday 5:30pm games</li>
                  <li>Midweek fixtures</li>
                  <li>Champions League included</li>
                </ul>
                <p class="note">Available through BT, Sky, Virgin Media, or Discovery+</p>
              </div>
              
              <div class="option-card">
                <h3>Amazon Prime Video</h3>
                <div class="price">£8.99/month</div>
                <ul>
                  <li>Boxing Day fixtures</li>
                  <li>New Year period matches</li>
                  <li>Prime delivery benefits</li>
                  <li>Prime Video content</li>
                </ul>
                <p class="note">Limited fixtures during festive season only</p>
              </div>
            </div>
          </section>
          
          <section class="card">
            <h2>Free Options</h2>
            <div class="free-options">
              <div class="free-option">
                <h3>BBC Match of the Day</h3>
                <p>Watch extended highlights of every Premier League match on Saturday nights (10:30pm) and Sunday mornings (10:00am). Available on BBC One and BBC iPlayer.</p>
              </div>
              <div class="free-option">
                <h3>Highlights on Social Media</h3>
                <p>Official Premier League social media accounts share short highlights and goal clips, though these are much shorter than TV highlights.</p>
              </div>
            </div>
          </section>
          
          <section class="card">
            <h2>Streaming vs Traditional TV</h2>
            <table class="comparison-table">
              <thead>
                <tr>
                  <th></th>
                  <th>Traditional TV</th>
                  <th>Streaming</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Picture Quality</strong></td>
                  <td>HD/4K on compatible TVs</td>
                  <td>Depends on internet connection</td>
                </tr>
                <tr>
                  <td><strong>Reliability</strong></td>
                  <td>Very reliable</td>
                  <td>Can buffer during peak times</td>
                </tr>
                <tr>
                  <td><strong>Flexibility</strong></td>
                  <td>Watch on main TV</td>
                  <td>Watch on any device, anywhere</td>
                </tr>
                <tr>
                  <td><strong>Cost</strong></td>
                  <td>Usually more expensive</td>
                  <td>Often cheaper monthly options</td>
                </tr>
              </tbody>
            </table>
          </section>
          
          <section class="card">
            <h2>Frequently Asked Questions</h2>
            <div class="faq">
              <div class="faq-item">
                <h3>Why aren't Saturday 3pm matches shown on TV?</h3>
                <p>The 3pm Saturday blackout protects attendance at lower league matches. This rule applies to all matches kicking off between 2:45pm and 5:15pm on Saturdays.</p>
              </div>
              <div class="faq-item">
                <h3>Can I watch matches for free legally?</h3>
                <p>Live Premier League matches require a subscription, but you can watch highlights for free on BBC Match of the Day and official social media channels.</p>
              </div>
              <div class="faq-item">
                <h3>What's the cheapest way to watch Premier League?</h3>
                <p>NOW TV Sports Pass (£14.99/month) gives you access to Sky Sports content without a long-term contract, making it the most flexible option.</p>
              </div>
            </div>
            <a href="#/premier-league/fixtures" class="btn">Find Today's Matches</a>
          </section>
        </article>
        
        <style>
          .content-page { max-width: 800px; margin: 0 auto; }
          .intro { font-size: 1.1rem; color: var(--color-muted); margin-bottom: 2rem; }
          .how-to-steps { padding-left: 1.2rem; }
          .how-to-steps li { margin: 1rem 0; }
          .subscription-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
          .option-card { padding: 1.5rem; border: 2px solid var(--color-border); border-radius: 12px; background: var(--color-card); }
          .option-card h3 { margin: 0 0 0.5rem; color: var(--competition-primary); }
          .price { font-size: 1.5rem; font-weight: bold; color: var(--competition-primary); margin-bottom: 1rem; }
          .option-card ul { margin: 1rem 0; padding-left: 1.2rem; }
          .option-card li { margin: 0.5rem 0; }
          .note { font-size: 0.9rem; color: var(--color-muted); margin-top: 1rem; }
          .free-options { display: grid; gap: 1rem; margin: 1rem 0; }
          .free-option { padding: 1rem; background: var(--color-background); border-radius: 8px; }
          .free-option h3 { margin: 0 0 0.5rem; }
          .comparison-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
          .comparison-table th, .comparison-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--color-border); }
          .comparison-table th { background: var(--color-background); font-weight: bold; }
          .faq { margin: 1.5rem 0; }
          .faq-item { margin: 1.5rem 0; padding-bottom: 1rem; border-bottom: 1px solid var(--color-border); }
          .faq-item:last-child { border-bottom: none; }
          .faq-item h3 { margin: 0 0 0.5rem; color: var(--competition-primary); }
          @media (max-width: 600px) {
            .subscription-options { grid-template-columns: 1fr; }
          }
        </style>`;
    }

    async function weekendFixturesView(){
      trackContentPageView('weekend-fixtures');
      const app = document.getElementById('app');
      
      try {
        // Get current date and find this weekend's fixtures
        const now = new Date();
        const currentDay = now.getDay(); // 0 = Sunday, 6 = Saturday
        
        // Calculate this weekend (Saturday-Monday)
        const daysToSaturday = currentDay === 0 ? 6 : (6 - currentDay); // If Sunday, next Saturday is 6 days away
        const saturday = new Date(now);
        saturday.setDate(now.getDate() + daysToSaturday);
        saturday.setHours(0, 0, 0, 0);
        
        const monday = new Date(saturday);
        monday.setDate(saturday.getDate() + 2);
        monday.setHours(23, 59, 59, 999);
        
        // Load fixtures for the weekend period using improved filtering
        const allFixtures = await loadFixtures(1, false); // Premier League, all fixtures
        const weekendFixtures = allFixtures.filter(f => {
          const fixtureDate = new Date(f.utc_kickoff);
          return fixtureDate >= saturday && fixtureDate <= monday;
        });
        
        if (!weekendFixtures.length) {
          app.innerHTML = `
            <article class="content-page">
              <header class="section">
                <h1>Premier League Fixtures This Weekend</h1>
                <p class="intro">No Premier League matches scheduled for this weekend.</p>
              </header>
              
              <section class="card">
                <h2>Alternative Weekend Football</h2>
                <p>While there are no Premier League matches this weekend, you can still catch football action:</p>
                <ul>
                  <li><strong>Championship</strong> - Check EFL Championship fixtures on Sky Sports</li>
                  <li><strong>International Football</strong> - Nations League and friendlies on various channels</li>
                  <li><strong>Match of the Day</strong> - Highlights from recent Premier League action on BBC</li>
                </ul>
                <a href="#/premier-league/fixtures" class="btn">View All Fixtures</a>
              </section>
            </article>`;
          return;
        }
        
        // Load broadcast data for weekend fixtures
        const broadcasts = {};
        if (weekendFixtures.length > 0) {
          try {
            const broadcastData = await jget(`/rest/v1/broadcasts?fixture_id=in.(${weekendFixtures.map(f => f.id).join(',')})&select=fixture_id,broadcaster,kickoff_time`);
            broadcastData.forEach(b => {
              if (!broadcasts[b.fixture_id]) broadcasts[b.fixture_id] = [];
              broadcasts[b.fixture_id].push(b);
            });
          } catch (e) {
            console.log('Could not load broadcast data:', e);
          }
        }
        
        // Group fixtures by day
        const groupedByDay = {};
        weekendFixtures.forEach(f => {
          const date = new Date(f.utc_kickoff);
          const dayKey = date.toLocaleDateString('en-GB', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
          });
          
          if (!groupedByDay[dayKey]) groupedByDay[dayKey] = [];
          groupedByDay[dayKey].push(f);
        });
        
        // Render weekend fixtures page
        const fixtureCards = Object.entries(groupedByDay).map(([dayName, dayFixtures]) => {
          const dayCards = dayFixtures.map(f => {
            const fixtureTime = new Date(f.utc_kickoff).toLocaleTimeString('en-GB', { 
              hour: '2-digit', 
              minute: '2-digit' 
            });
            
            const fixtureBroadcasts = broadcasts[f.id] || [];
            const broadcastInfo = fixtureBroadcasts.length > 0 
              ? fixtureBroadcasts.map(b => b.broadcaster).join(', ')
              : 'Broadcast TBC';
            
            return `
              <div class="fixture-weekend-card">
                <div class="match-teams">
                  <div class="team-row">
                    ${f.home_crest ? `<img src="${f.home_crest}" alt="${f.home_team}" class="crest">` : ''}
                    <span>${f.home_team}</span>
                  </div>
                  <div class="vs">vs</div>
                  <div class="team-row">
                    ${f.away_crest ? `<img src="${f.away_crest}" alt="${f.away_team}" class="crest">` : ''}
                    <span>${f.away_team}</span>
                  </div>
                </div>
                <div class="match-info">
                  <div class="kick-off-time">${fixtureTime}</div>
                  <div class="broadcast-info ${fixtureBroadcasts.length > 0 ? 'has-broadcast' : 'no-broadcast'}">
                    📺 ${broadcastInfo}
                  </div>
                </div>
              </div>`;
          }).join('');
          
          return `
            <section class="day-section">
              <h2>${dayName}</h2>
              <div class="day-fixtures">
                ${dayCards}
              </div>
            </section>`;
        }).join('');
        
        const dateRange = `${saturday.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${monday.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
        
        app.innerHTML = `
          <article class="content-page weekend-fixtures">
            <header class="section">
              <h1>Premier League Fixtures This Weekend</h1>
              <p class="intro">Complete TV guide for all Premier League matches from ${dateRange}. Find which UK broadcaster is showing each game.</p>
            </header>
            
            ${fixtureCards}
            
            <section class="card weekend-info">
              <h2>Weekend Viewing Guide</h2>
              <div class="viewing-tips">
                <div class="tip">
                  <h3>📺 Where to Watch</h3>
                  <p>Most weekend Premier League matches are shown on <strong>Sky Sports</strong> (Saturday 12:30pm and Sunday games) or <strong>TNT Sports</strong> (Saturday 5:30pm). Remember that Saturday 3pm kick-offs are not televised in the UK due to the broadcasting blackout.</p>
                </div>
                
                <div class="tip">
                  <h3>⏰ Key Times</h3>
                  <ul>
                    <li><strong>Saturday 12:30pm</strong> - Usually Sky Sports Main Event</li>
                    <li><strong>Saturday 3:00pm</strong> - Not televised (3pm blackout)</li>
                    <li><strong>Saturday 5:30pm</strong> - Usually TNT Sports</li>
                    <li><strong>Sunday 2:00pm & 4:30pm</strong> - Sky Sports Premier League</li>
                  </ul>
                </div>
                
                <div class="tip">
                  <h3>💡 Free Options</h3>
                  <p>Can't watch live? Catch up with <strong>Match of the Day</strong> on BBC One every Saturday at 10:30pm and Sunday at 10:00am. Extended highlights available on BBC iPlayer.</p>
                </div>
              </div>
              
              <div class="weekend-cta">
                <a href="#/tv-guide" class="btn">Complete TV Guide</a>
                <a href="#/how-to-watch-premier-league" class="btn">How to Watch Guide</a>
              </div>
            </section>
          </article>
          
          <style>
            .weekend-fixtures .fixture-weekend-card {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 1.5rem;
              margin: 1rem 0;
              border: 1px solid var(--color-border);
              border-radius: 12px;
              background: var(--color-card);
              transition: box-shadow 0.2s ease;
            }
            
            .weekend-fixtures .fixture-weekend-card:hover {
              box-shadow: var(--shadow-md);
            }
            
            .match-teams {
              display: flex;
              align-items: center;
              gap: 1rem;
              flex: 1;
            }
            
            .team-row {
              display: flex;
              align-items: center;
              gap: 8px;
              font-weight: 500;
              min-width: 120px;
            }
            
            .vs {
              color: var(--color-muted);
              font-size: 0.9rem;
              margin: 0 0.5rem;
            }
            
            .match-info {
              text-align: right;
              display: flex;
              flex-direction: column;
              gap: 0.5rem;
            }
            
            .kick-off-time {
              font-weight: bold;
              font-size: 1.1rem;
              color: var(--competition-primary);
            }
            
            .broadcast-info {
              font-size: 0.9rem;
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
            }
            
            .broadcast-info.has-broadcast {
              background: #d4edda;
              color: #155724;
            }
            
            .broadcast-info.no-broadcast {
              background: #fff3cd;
              color: #856404;
            }
            
            .day-section {
              margin: 2rem 0;
            }
            
            .day-section h2 {
              margin: 0 0 1rem;
              color: var(--competition-primary);
              border-bottom: 2px solid var(--competition-primary);
              padding-bottom: 0.5rem;
            }
            
            .viewing-tips {
              display: grid;
              gap: 1.5rem;
              margin: 1.5rem 0;
            }
            
            .tip h3 {
              margin: 0 0 0.5rem;
              color: var(--competition-primary);
            }
            
            .tip p, .tip ul {
              margin: 0.5rem 0;
              line-height: 1.6;
            }
            
            .weekend-cta {
              display: flex;
              gap: 1rem;
              margin-top: 1.5rem;
            }
            
            @media (max-width: 600px) {
              .fixture-weekend-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
              }
              
              .match-teams {
                width: 100%;
                justify-content: space-between;
              }
              
              .match-info {
                align-self: flex-end;
                text-align: right;
              }
              
              .weekend-cta {
                flex-direction: column;
              }
            }
          </style>`;
          
      } catch (error) {
        console.error('Error loading weekend fixtures:', error);
        app.innerHTML = `
          <article class="content-page">
            <header class="section">
              <h1>Premier League Fixtures This Weekend</h1>
              <p class="intro">Unable to load fixture information at the moment.</p>
            </header>
            
            <section class="card">
              <h2>Alternative Options</h2>
              <p>While we can't load the fixtures right now, you can:</p>
              <ul>
                <li>Check the <a href="#/premier-league/fixtures">main fixtures page</a></li>
                <li>View our <a href="#/tv-guide">complete TV guide</a></li>
                <li>Learn <a href="#/how-to-watch-premier-league">how to watch Premier League</a></li>
              </ul>
            </section>
          </article>`;
      }
    }

    function aboutView(){
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="card">
          <div class="section">
            <h2 style="margin:0 0 6px">About this site</h2>
            <p>Browse upcoming Premier League fixtures. Use the <strong>Fixtures</strong> page to filter by matchweek and time zone, or jump via the <strong>Clubs</strong> list.</p>
            <p>Open a match to see UK broadcast options when available. More data and features are coming soon.</p>
            <p class="muted">Version: ${APP_VERSION}</p>
          </div>
        </div>`;
    }

    // ---- Team-specific viewing guides ----
    async function teamViewingGuideView() {
      const app = document.getElementById('app');
      const params = new URLSearchParams(window.location.search);
      const teamSlug = params.get('team');
      
      if (!teamSlug) {
        // Show team selector page
        try {
          const teams = await loadTeams(1, true); // Load Premier League teams
          const teamOptions = teams.map(t => `
            <a href="/football/how-to-watch?team=${encodeURIComponent(t.slug)}" class="team-guide-card">
              <div class="team-card-content">
                ${t.crest_url ? `<img src="${t.crest_url}" alt="${t.name}" class="team-crest">` : ''}
                <div class="team-name">${getTeamAlias(t.name)}</div>
                <div class="team-guide-preview">How to watch ${getTeamAlias(t.name)} matches</div>
              </div>
            </a>
          `).join('');
          
          updateMetaTags(
            "How to Watch Premier League Teams | fixtures.app",
            "Complete TV viewing guides for every Premier League team. Find which UK broadcasters show your team's matches - Sky Sports, TNT Sports, BBC coverage.",
            {
              title: "How to Watch Premier League Teams | fixtures.app", 
              description: "Complete TV viewing guides for every Premier League team. Find which UK broadcasters show your team's matches - Sky Sports, TNT Sports, BBC coverage.",
              url: "https://football-listings.netlify.app/football/how-to-watch"
            }
          );
          
          app.innerHTML = `
            <article class="content-page team-guides">
              <header class="section">
                <h1>How to Watch Premier League Teams</h1>
                <p class="intro">Complete TV viewing guides for every Premier League club. Find which UK broadcasters show your team's matches.</p>
              </header>
              
              <section class="teams-grid">
                ${teamOptions}
              </section>
              
              <section class="card general-info">
                <h2>General Premier League TV Coverage</h2>
                <div class="broadcaster-overview">
                  <div class="broadcaster-card">
                    <h3>Sky Sports</h3>
                    <p>Shows the most Premier League matches including Saturday 12:30pm and most Sunday games. Available via Sky TV, NOW TV, or streaming.</p>
                  </div>
                  <div class="broadcaster-card">
                    <h3>TNT Sports</h3>
                    <p>Shows Saturday 5:30pm games and some midweek fixtures. Available via BT, Amazon Prime Video, or Discovery+.</p>
                  </div>
                  <div class="broadcaster-card">
                    <h3>Amazon Prime Video</h3>
                    <p>Exclusive coverage of select Boxing Day and New Year fixtures. Included with Prime membership.</p>
                  </div>
                  <div class="broadcaster-card">
                    <h3>BBC</h3>
                    <p>Match of the Day highlights every weekend. Free-to-air coverage available on BBC One and iPlayer.</p>
                  </div>
                </div>
              </section>
            </article>
            
            <style>
              .team-guides .teams-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
                margin: 2rem 0;
              }
              
              .team-guide-card {
                display: block;
                text-decoration: none;
                color: inherit;
                border: 1px solid var(--color-border);
                border-radius: 12px;
                padding: 1.5rem;
                background: var(--color-card);
                transition: all 0.2s ease;
              }
              
              .team-guide-card:hover {
                box-shadow: var(--shadow-md);
                transform: translateY(-2px);
                border-color: var(--competition-primary);
              }
              
              .team-card-content {
                text-align: center;
              }
              
              .team-crest {
                width: 48px;
                height: 48px;
                object-fit: contain;
                margin-bottom: 1rem;
              }
              
              .team-name {
                font-weight: bold;
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
                color: var(--color-text);
              }
              
              .team-guide-preview {
                color: var(--color-muted);
                font-size: 0.9rem;
              }
              
              .broadcaster-overview {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
              }
              
              .broadcaster-card {
                padding: 1rem;
                border: 1px solid var(--color-border);
                border-radius: 8px;
                background: var(--color-background);
              }
              
              .broadcaster-card h3 {
                margin: 0 0 0.5rem;
                color: var(--competition-primary);
              }
              
              .broadcaster-card p {
                margin: 0;
                color: var(--color-muted);
                font-size: 0.9rem;
                line-height: 1.4;
              }
            </style>
          `;
          trackContentPageView('team-guides-index');
          return;
        } catch (error) {
          console.error('Error loading teams for viewing guides:', error);
          app.innerHTML = `<div class="card"><p class="muted">Unable to load team viewing guides: ${error.message}</p><p><a href="#/">← Back to Home</a></p></div>`;
          return;
        }
      }
      
      // Show individual team viewing guide
      try {
        const teams = await loadTeams(1, true);
        const team = teams.find(t => t.slug === teamSlug);
        
        if (!team) {
          app.innerHTML = `<div class="card"><p class="muted">Team not found. <a href="/football/how-to-watch">← Back to Team Guides</a></p></div>`;
          return;
        }
        
        // Load recent fixtures for this team to show broadcasting patterns (current season only)
        const currentSeasonStart = '2024-08-01T00:00:00.000Z';
        const fixtures = await jget(`/rest/v1/fixtures?or=(home_team_id.eq.${team.id},away_team_id.eq.${team.id})&utc_kickoff=gte.${currentSeasonStart}&order=utc_kickoff.desc&limit=10&select=id,utc_kickoff,home_team,away_team,matchday`);
        
        // Load broadcast data for these fixtures
        const broadcasts = {};
        if (fixtures.length > 0) {
          try {
            const broadcastData = await jget(`/rest/v1/broadcasts?fixture_id=in.(${fixtures.map(f => f.id).join(',')})&select=fixture_id,broadcaster,kickoff_time`);
            broadcastData.forEach(b => {
              if (!broadcasts[b.fixture_id]) broadcasts[b.fixture_id] = [];
              broadcasts[b.fixture_id].push(b);
            });
          } catch (e) {
            console.log('Could not load broadcast data for team fixtures:', e);
          }
        }
        
        // Analyze broadcasting patterns for this team
        const broadcastAnalysis = analyzeBroadcastPatterns(fixtures, broadcasts);
        
        const teamName = getTeamAlias(team.name);
        updateMetaTags(
          `How to Watch ${teamName} Matches | Premier League TV Guide`,
          `Complete guide to watching ${teamName} Premier League matches on UK TV. Find which broadcasters show ${teamName} games - Sky Sports, TNT Sports, Amazon Prime coverage.`,
          {
            title: `How to Watch ${teamName} Matches | Premier League TV Guide`,
            description: `Complete guide to watching ${teamName} Premier League matches on UK TV. Find which broadcasters show ${teamName} games - Sky Sports, TNT Sports, Amazon Prime coverage.`,
            url: `https://football-listings.netlify.app/football/how-to-watch?team=${teamSlug}`
          }
        );
        
        app.innerHTML = `
          <article class="content-page team-viewing-guide">
            <header class="section">
              <div class="team-header">
                ${team.crest_url ? `<img src="${team.crest_url}" alt="${teamName}" class="team-hero-crest">` : ''}
                <div class="team-title">
                  <h1>How to Watch ${teamName} Matches</h1>
                  <p class="intro">Complete TV guide for ${teamName} Premier League fixtures on UK broadcasters.</p>
                </div>
              </div>
            </header>
            
            ${generateBroadcastingInsights(teamName, broadcastAnalysis)}
            
            <section class="card team-fixtures-preview">
              <h2>Recent ${teamName} Fixtures</h2>
              ${generateRecentFixturesPreview(fixtures, broadcasts, team.id)}
            </section>
            
            <section class="card broadcaster-specific">
              <h2>Where to Find ${teamName} on TV</h2>
              <div class="broadcaster-guides">
                <div class="guide-item">
                  <h3>🏆 Sky Sports Premier League</h3>
                  <p>Most ${teamName} matches on Saturdays (12:30pm) and Sundays. Available on Sky TV packages or stream with NOW TV Sports passes.</p>
                  <div class="typical-times">Typical times: Sat 12:30pm, Sun 2:00pm, Sun 4:30pm</div>
                </div>
                
                <div class="guide-item">
                  <h3>⚡ TNT Sports</h3>
                  <p>Saturday evening ${teamName} games (5:30pm) and some midweek European fixtures. Available via BT TV, Amazon Prime Video, or Discovery+.</p>
                  <div class="typical-times">Typical times: Sat 5:30pm, weekday evening Champions League</div>
                </div>
                
                <div class="guide-item">
                  <h3>📺 Amazon Prime Video</h3>
                  <p>Exclusive ${teamName} matches during Christmas period and select fixtures. Included with Prime membership - no extra sports package needed.</p>
                  <div class="typical-times">Exclusive: Boxing Day and New Year fixtures</div>
                </div>
                
                <div class="guide-item">
                  <h3>🎬 BBC Match of the Day</h3>
                  <p>Free highlights of all ${teamName} matches every weekend. Watch on BBC One or catch up on iPlayer anytime.</p>
                  <div class="typical-times">Saturday 10:30pm, Sunday 10:00am</div>
                </div>
              </div>
            </section>
            
            <section class="card team-viewing-tips">
              <h2>Watching ${teamName}: Pro Tips</h2>
              <div class="tips-grid">
                <div class="tip">
                  <h3>📅 Plan Ahead</h3>
                  <p>Check TV schedules 1-2 weeks before matchday. ${teamName} fixtures often move for TV coverage.</p>
                </div>
                <div class="tip">
                  <h3>💰 Save Money</h3>
                  <p>NOW TV day passes cost £14.99 for Sky Sports. Perfect for watching ${teamName}'s biggest games without monthly commitment.</p>
                </div>
                <div class="tip">
                  <h3>📱 Never Miss Out</h3>
                  <p>Set up notifications for ${teamName} fixture changes and TV schedule updates on our homepage.</p>
                </div>
                <div class="tip">
                  <h3>⚽ 3pm Blackout</h3>
                  <p>Saturday 3pm ${teamName} matches aren't televised in UK. Listen on BBC Radio 5 Live or follow online updates.</p>
                </div>
              </div>
            </section>
            
            <section class="team-cta">
              <a href="#/premier-league/fixtures" class="btn">View All ${teamName} Fixtures</a>
              <a href="#/tv-guide" class="btn">Complete TV Guide</a>
              <a href="/football/how-to-watch" class="btn">Other Teams</a>
            </section>
          </article>
          
          <style>
            .team-viewing-guide .team-header {
              display: flex;
              align-items: center;
              gap: 2rem;
              margin-bottom: 2rem;
            }
            
            .team-hero-crest {
              width: 80px;
              height: 80px;
              object-fit: contain;
            }
            
            .team-title h1 {
              margin: 0 0 0.5rem;
              font-size: 2.5rem;
            }
            
            .broadcaster-guides {
              display: grid;
              gap: 1.5rem;
              margin-top: 1rem;
            }
            
            .guide-item {
              padding: 1.5rem;
              border: 1px solid var(--color-border);
              border-radius: 12px;
              background: var(--color-background);
            }
            
            .guide-item h3 {
              margin: 0 0 1rem;
              color: var(--competition-primary);
              font-size: 1.2rem;
            }
            
            .guide-item p {
              margin: 0 0 0.5rem;
              line-height: 1.5;
            }
            
            .typical-times {
              font-size: 0.85rem;
              color: var(--color-muted);
              font-style: italic;
            }
            
            .tips-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 1rem;
              margin-top: 1rem;
            }
            
            .tip {
              padding: 1rem;
              border-left: 4px solid var(--competition-primary);
              background: var(--color-background);
              border-radius: 0 8px 8px 0;
            }
            
            .tip h3 {
              margin: 0 0 0.5rem;
              font-size: 1rem;
            }
            
            .tip p {
              margin: 0;
              font-size: 0.9rem;
              line-height: 1.4;
            }
            
            .team-cta {
              text-align: center;
              margin: 3rem 0 2rem;
              display: flex;
              gap: 1rem;
              justify-content: center;
              flex-wrap: wrap;
            }
            
            .broadcast-insights {
              background: linear-gradient(135deg, var(--competition-primary), #4a00a0);
              color: white;
              padding: 2rem;
              border-radius: 12px;
              margin: 2rem 0;
            }
            
            .insights-stats {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
              gap: 1rem;
              margin-top: 1rem;
            }
            
            .stat {
              text-align: center;
              padding: 1rem;
              background: rgba(255,255,255,0.1);
              border-radius: 8px;
            }
            
            .stat-number {
              font-size: 2rem;
              font-weight: bold;
              display: block;
            }
            
            .stat-label {
              font-size: 0.9rem;
              opacity: 0.9;
              margin-top: 0.5rem;
            }
            
            @media (max-width: 768px) {
              .team-header {
                flex-direction: column;
                text-align: center;
              }
              
              .team-title h1 {
                font-size: 2rem;
              }
              
              .team-cta {
                flex-direction: column;
                align-items: center;
              }
            }
          </style>
        `;
        
        trackContentPageView(`team-guide-${teamSlug}`);
        
      } catch (error) {
        console.error('Error loading team viewing guide:', error);
        app.innerHTML = `<div class="card"><p class="muted">Unable to load viewing guide: ${error.message}</p><p><a href="/football/how-to-watch">← Back to Team Guides</a></p></div>`;
      }
    }
    
    function analyzeBroadcastPatterns(fixtures, broadcasts) {
      let skyCount = 0;
      let tntCount = 0;
      let amazonCount = 0;
      let totalBroadcast = 0;
      
      fixtures.forEach(f => {
        const fixtureBroadcasts = broadcasts[f.id] || [];
        if (fixtureBroadcasts.length > 0) {
          totalBroadcast++;
          fixtureBroadcasts.forEach(b => {
            const broadcaster = b.broadcaster?.toLowerCase() || '';
            if (broadcaster.includes('sky')) skyCount++;
            else if (broadcaster.includes('tnt') || broadcaster.includes('bt sport')) tntCount++;
            else if (broadcaster.includes('amazon') || broadcaster.includes('prime')) amazonCount++;
          });
        }
      });
      
      return {
        totalFixtures: fixtures.length,
        totalBroadcast,
        skyCount,
        tntCount,
        amazonCount,
        broadcastPercentage: Math.round((totalBroadcast / fixtures.length) * 100)
      };
    }
    
    function generateBroadcastingInsights(teamName, analysis) {
      if (analysis.totalFixtures === 0) {
        return `
          <section class="broadcast-insights">
            <h2>${teamName} TV Coverage Insights</h2>
            <p>Broadcasting data will appear here once the season fixtures are available.</p>
          </section>`;
      }
      
      const primaryBroadcaster = analysis.skyCount > analysis.tntCount ? 'Sky Sports' : 'TNT Sports';
      const coverageNote = analysis.broadcastPercentage > 70 ? 'excellent' : analysis.broadcastPercentage > 50 ? 'good' : 'limited';
      
      return `
        <section class="broadcast-insights">
          <h2>${teamName} TV Coverage Insights</h2>
          <p>Based on recent ${teamName} fixtures, here's your viewing pattern:</p>
          
          <div class="insights-stats">
            <div class="stat">
              <span class="stat-number">${analysis.broadcastPercentage}%</span>
              <div class="stat-label">Matches on TV</div>
            </div>
            <div class="stat">
              <span class="stat-number">${primaryBroadcaster === 'Sky Sports' ? 'Sky' : 'TNT'}</span>
              <div class="stat-label">Primary Channel</div>
            </div>
            <div class="stat">
              <span class="stat-number">${analysis.totalBroadcast}</span>
              <div class="stat-label">Recent TV Games</div>
            </div>
          </div>
          
          <p style="margin-top: 1rem; opacity: 0.9;">
            ${teamName} has ${coverageNote} TV coverage with most matches appearing on ${primaryBroadcaster}.
          </p>
        </section>`;
    }
    
    function generateRecentFixturesPreview(fixtures, broadcasts, teamId) {
      if (!fixtures.length) return '<p class="muted">No recent fixtures available.</p>';
      
      const recentFixtures = fixtures.slice(0, 5).map(f => {
        const isHome = f.home_team_id === teamId;
        const opponent = isHome ? f.away_team : f.home_team;
        const fixtureDate = new Date(f.utc_kickoff).toLocaleDateString('en-GB', { 
          day: 'numeric', 
          month: 'short' 
        });
        
        const fixtureBroadcasts = broadcasts[f.id] || [];
        const broadcastInfo = fixtureBroadcasts.length > 0 
          ? fixtureBroadcasts.map(b => b.broadcaster).join(', ')
          : 'Not televised';
        
        return `
          <div class="fixture-preview">
            <div class="fixture-teams">
              <span class="match-desc">${isHome ? 'vs' : '@'} ${opponent}</span>
              <span class="fixture-date">${fixtureDate}</span>
            </div>
            <div class="broadcast-channel">${broadcastInfo}</div>
          </div>`;
      }).join('');
      
      return `
        <div class="fixtures-preview-list">
          ${recentFixtures}
        </div>
        <style>
          .fixtures-preview-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
          }
          
          .fixture-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--color-background);
            border-radius: 8px;
            border-left: 3px solid var(--competition-primary);
          }
          
          .fixture-teams {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
          }
          
          .match-desc {
            font-weight: 500;
          }
          
          .fixture-date {
            font-size: 0.85rem;
            color: var(--color-muted);
          }
          
          .broadcast-channel {
            font-size: 0.9rem;
            color: var(--competition-primary);
            font-weight: 500;
          }
        </style>`;
    }

    // Debug Data View temporarily disabled
    
    function generateFixtureManagerList(fixtures, broadcastLookup, providers) {
      return fixtures.slice(0, 25).map(f => {
        const broadcasts = broadcastLookup[f.id] || [];
        const hasBroadcast = broadcasts.length > 0;
        const fixtureDate = new Date(f.utc_kickoff).toLocaleDateString('en-GB', { 
          weekday: 'short', 
          day: 'numeric', 
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const broadcastStatus = broadcasts.length > 0 
          ? broadcasts.map(b => 
              '<div class="broadcast-item ' + (b.verified ? 'verified' : 'unverified') + '">' +
                (b.broadcaster || 'Unknown') + (b.channel_name ? ' (' + b.channel_name + ')' : '') +
                (b.verified ? ' ✅' : ' ⚠️') +
              '</div>'
            ).join('')
          : '<div class="broadcast-item missing">❌ No broadcast assigned</div>';
        
        return 
          '<div class="fixture-admin-card ' + (hasBroadcast ? 'has-broadcast' : 'missing-broadcast') + '">' +
            '<div class="fixture-info">' +
              '<div class="fixture-match">' + f.home_team + ' vs ' + f.away_team + '</div>' +
              '<div class="fixture-date">' + fixtureDate + ' • MW' + (f.matchday || '?') + '</div>' +
            '</div>' +
            '<div class="broadcast-status">' +
              broadcastStatus +
            '</div>' +
            '<div class="fixture-actions">' +
              '<button class="mini-btn" onclick="editFixtureBroadcast(' + f.id + ')">✏️ Edit</button>' +
              '<button class="mini-btn" onclick="verifyBroadcast(' + f.id + ')">✅ Verify</button>' +
            '</div>' +
          '</div>';
      }).join('');
    }

    // ---- helper with fallbacks ----
    async function jget(path){
      console.log('JGET Request:', `${SUPABASE_CONFIG.url}${path}`);
      const r = await fetch(`${SUPABASE_CONFIG.url}${path}`, { headers: API_HEADERS });
      if (!r.ok) {
        const errorText = await r.text();
        console.error('JGET Error:', r.status, r.statusText, errorText);
        throw new Error(`${r.status} ${r.statusText} - ${errorText}`);
      }
      const data = await r.json();
      console.log('JGET Response:', data?.length || 0, 'records');
      return data;
    }
    
    // Clean database - no data integrity filters needed

    // Robust team loader with fallbacks and data integrity filtering
    async function loadTeams(competitionId, fallbackToAll = false) {
      const attempts = [
        // Try teams table with competition_id filter
        `${API_ENDPOINTS.teams}?competition_id=eq.${competitionId}&select=id,name,slug,crest_url`,
        // Try teams_v with no competition filter if schema doesn't support it
        `${API_ENDPOINTS.teams.replace('/teams', '/teams_v')}?select=id,name,slug,crest_url`,
        // Fallback to all teams from main table
        fallbackToAll ? `${API_ENDPOINTS.teams}?select=id,name,slug,crest_url,competition_id` : null
      ].filter(Boolean);
      
      for (const endpoint of attempts) {
        try {
          console.log(`Trying teams endpoint: ${endpoint}`);
          const teams = await jget(endpoint);
          
          // Filter by competition_id if we got data with that field
          if (teams && teams.length > 0) {
            let filtered = teams.filter(t => !competitionId || t.competition_id === competitionId || !t.competition_id);
            
            if (filtered.length > 0) {
              console.log(`Successfully loaded ${filtered.length} teams for competition ${competitionId}`);
              return filtered;
            }
          }
        } catch (error) {
          console.warn(`Teams endpoint failed: ${endpoint}`, error.message);
          continue;
        }
      }
      
      console.warn(`No teams found for competition ${competitionId}, returning empty array to prevent app breakage`);
      return [];
    }
    
    // Robust fixture loader with fallbacks
    async function loadFixtures(competitionId, includeUpcoming = true) {
      const nowIso = includeUpcoming ? new Date().toISOString() : null;
      const timeFilter = includeUpcoming ? `&utc_kickoff=gte.${nowIso}` : '';
      
      // Better filtering: only get fixtures from current season with valid matchdays
      const currentSeasonStart = '2024-08-01T00:00:00.000Z'; // Premier League 2024-25 season
      const seasonFilter = `&utc_kickoff=gte.${currentSeasonStart}`;
      const matchdayFilter = '&matchday=gte.1&matchday=lte.38'; // Valid PL matchdays
      
      const attempts = [
        // Primary: Current season fixtures with valid matchdays
        `${API_ENDPOINTS.fixturesList}?competition_id=eq.${competitionId}${timeFilter}${seasonFilter}${matchdayFilter}&${QUERY_PARAMS.orderByKickoff}&limit=${QUERY_PARAMS.limit}`,
        // Fallback: Current season fixtures without matchday constraint
        `${API_ENDPOINTS.fixturesList}?competition_id=eq.${competitionId}${timeFilter}${seasonFilter}&${QUERY_PARAMS.orderByKickoff}&limit=${QUERY_PARAMS.limit}`,
        // Fallback: All season fixtures with matchday constraint
        includeUpcoming ? `${API_ENDPOINTS.fixturesList}?competition_id=eq.${competitionId}${seasonFilter}${matchdayFilter}&${QUERY_PARAMS.orderByKickoff}&limit=${QUERY_PARAMS.limit}` : null,
        // Last resort: Basic query with just competition filter
        `${API_ENDPOINTS.fixturesList}?competition_id=eq.${competitionId}${timeFilter}&${QUERY_PARAMS.orderByKickoff}&limit=${QUERY_PARAMS.limit}`
      ].filter(Boolean);
      
      for (const endpoint of attempts) {
        try {
          console.log(`Trying fixtures endpoint: ${endpoint}`);
          const fixtures = await jget(endpoint);
          
          if (fixtures && fixtures.length > 0) {
            // Additional safety filter: exclude suspicious low-ID fixtures as backup
            const filtered = fixtures.filter(f => f.id && f.id > 30);
            const removedCount = fixtures.length - filtered.length;
            if (removedCount > 0) {
              console.log(`Successfully loaded ${fixtures.length} fixtures for competition ${competitionId}, filtered to ${filtered.length} (removed ${removedCount} low-ID fixtures)`);
            } else {
              console.log(`Successfully loaded ${filtered.length} valid fixtures for competition ${competitionId}`);
            }
            return filtered;
          }
        } catch (error) {
          console.warn(`Fixtures endpoint failed: ${endpoint}`, error.message);
          continue;
        }
      }
      
      console.warn(`No fixtures found for competition ${competitionId}`);
      return [];
    }
  </script>

  <!-- Version badge -->
  <a id="ver" href="/CHANGELOG.md" target="_blank" rel="noopener" 
     aria-label="View version changelog" 
     title="View changelog"
     style="position:fixed;right:12px;bottom:12px;background:#111;color:#fff;font:12px/1 system-ui;padding:6px 8px;border-radius:8px;opacity:.85;z-index:9999;text-decoration:none;cursor:pointer"></a>
  <script>
    // Keep version badge inline; switch to app.js later if desired
    document.addEventListener('DOMContentLoaded', function(){
      const v = (window.APP_VERSION && typeof window.APP_VERSION === 'string') ? window.APP_VERSION : 'v0.0.0';
      var el = document.getElementById('ver');
      if (el) el.textContent = v;
      
      // Initialize competition selector after a short delay to ensure module is loaded
      setTimeout(initCompetitionSelector, 100);
    });
    
    function initCompetitionSelector() {
      const toggleBtn = document.getElementById('competition-toggle');
      const dropdown = document.getElementById('competition-dropdown');
      const currentCompSpan = document.getElementById('current-competition');
      
      if (!toggleBtn || !dropdown || !currentCompSpan) {
        console.warn('Competition selector elements not found');
        return;
      }
      
      // Check if window functions are available
      if (!window.getActiveCompetitions || !window.parseRoute || !window.getCompetition) {
        console.warn('Required functions not yet available, retrying...');
        setTimeout(initCompetitionSelector, 200);
        return;
      }
      
      // Get COMPETITIONS from the module scope
      const activeCompetitions = window.getActiveCompetitions();
      dropdown.innerHTML = activeCompetitions.map(comp => 
        `<a href="/football/${comp.slug}/fixtures" class="competition-option" data-slug="${comp.slug}">
          <img src="/favicon.ico" alt="${comp.country}" width="16" height="16">
          <span>${comp.name}</span>
        </a>`
      ).join('');
      
      // Set current competition display
      function updateCurrentCompetition() {
        const route = window.parseRoute();
        const comp = window.getCompetition(route.competition);
        currentCompSpan.textContent = comp.shortName;
        window.updateNavigationLinks(route.competition);
        window.updateCompetitionStyling(route.competition);
      }
      
      updateCurrentCompetition();
      
      // Toggle dropdown
      toggleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropdown.classList.toggle('show');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        dropdown.classList.remove('show');
      });
      
      // Handle competition selection
      dropdown.addEventListener('click', (e) => {
        const option = e.target.closest('.competition-option');
        if (!option) return;
        
        e.preventDefault();
        dropdown.classList.remove('show');
        
        // Navigate to selected competition
        const href = option.getAttribute('href');
        if (href) {
          window.navigate(href);
        }
      });
      
      // Update competition display on navigation
      window.addEventListener('popstate', updateCurrentCompetition);
    }
  </script>

  <!-- Plausible (replace domain when ready) -->
  <script defer data-domain="football-listings.netlify.app" src="https://plausible.io/js/script.js"></script>
</body>
</html>