<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Premier League Fixtures & TV Guide - Where to Watch</title>
    <meta name="description" content="Find out which TV channel is showing Premier League matches today. Complete fixture list with Sky Sports, TNT Sports, Amazon Prime and BBC broadcaster information.">
    <meta name="keywords" content="Premier League, TV guide, fixtures, Sky Sports, TNT Sports, Amazon Prime, BBC, where to watch football">
    
    <!-- Open Graph for Social Sharing -->
    <meta property="og:title" content="Premier League Fixtures & TV Guide">
    <meta property="og:description" content="Never miss a match - find out which channel is showing your team's games">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://football-listings.netlify.app">
    <meta property="og:site_name" content="Football Listings">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Premier League Fixtures & TV Guide">
    <meta name="twitter:description" content="Find out which channel is showing your team's Premier League matches">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }
        
        /* Error Banner Styles */
        .error-banner {
            background: #e74c3c;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 500;
            border-radius: 4px;
            margin-bottom: 1rem;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Loading Styles */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
            font-size: 1.2rem;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #7f8c8d;
            border-top: 2px solid transparent;
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Filters */
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .filter-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        /* Fixtures */
        .fixtures-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .fixture {
            border-bottom: 1px solid #eee;
            padding: 1.5rem;
            transition: background-color 0.2s;
        }
        
        .fixture:hover {
            background-color: #f8f9fa;
        }
        
        .fixture:last-child {
            border-bottom: none;
        }
        
        .fixture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .fixture-teams {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .fixture-date {
            color: #7f8c8d;
            font-size: 0.95rem;
        }
        
        .broadcasters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .broadcaster-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .broadcaster-btn:hover {
            background: #2980b9;
        }
        
        .broadcaster-btn.sky { background: #1e3a8a; }
        .broadcaster-btn.tnt { background: #dc2626; }
        .broadcaster-btn.amazon { background: #f59e0b; }
        .broadcaster-btn.bbc { background: #7c3aed; }
        
        .no-fixtures {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        /* Footer */
        footer {
            margin-top: 3rem;
            padding: 2rem 0;
            text-align: center;
            color: #7f8c8d;
            border-top: 1px solid #eee;
        }
        
        .version-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .fixture-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .broadcasters {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Premier League Fixtures</h1>
            <p class="subtitle">Find out which TV channel is showing your team's matches</p>
        </div>
    </header>

    <main class="container">
        <!-- Error messages will be inserted here -->
        
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label for="team-filter">Filter by Team:</label>
                <select id="team-filter">
                    <option value="">All Teams</option>
                </select>
                
                <label for="matchweek-filter">Matchweek:</label>
                <select id="matchweek-filter">
                    <option value="">All Matchweeks</option>
                </select>
                
                <label for="time-filter">Show:</label>
                <select id="time-filter">
                    <option value="upcoming">Upcoming Only</option>
                    <option value="all">All Fixtures</option>
                </select>
            </div>
        </div>

        <!-- Fixtures List -->
        <div class="fixtures-container">
            <div id="fixtures-list">
                <div class="loading">Loading fixtures...</div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Football Listings. Find where to watch Premier League matches on TV.</p>
            <p>Data provided by TheSportsDB. Broadcaster information updated regularly.</p>
        </div>
    </footer>

    <div class="version-badge">v1.1.0</div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://ksqyurqkqznzrntdpood.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzcXl1cnFrcXpuenJudGRwb29kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTEwNjAsImV4cCI6MjA3MjM2NzA2MH0.wVBZBEbfctB7JPnpMZkXKMGwXlYxGWjOF_AxixVo-S4';
        
        // Global state
        let allFixtures = [];
        let allTeams = [];
        let currentFilters = {
            team: '',
            matchweek: '',
            time: 'upcoming'
        };

        // Utility Functions
        function showError(message) {
            removeExistingErrors();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-banner';
            errorDiv.textContent = message;
            document.querySelector('main').insertBefore(errorDiv, document.querySelector('main').firstChild);
            
            // Auto-hide after 5 seconds
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function removeExistingErrors() {
            const existingErrors = document.querySelectorAll('.error-banner');
            existingErrors.forEach(error => error.remove());
        }

        function showLoading() {
            document.getElementById('fixtures-list').innerHTML = 
                '<div class="loading">Loading fixtures...</div>';
        }

        function hideLoading() {
            const loading = document.querySelector('.loading');
            if (loading) loading.remove();
        }

        // API Functions with Error Handling
        async function fetchWithErrorHandling(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showError('Unable to load data. Please check your connection and try again.');
                return null;
            }
        }

        // Data Loading Functions
        async function loadTeams() {
            const teams = await fetchWithErrorHandling(`${SUPABASE_URL}/rest/v1/teams?select=*&order=name`);
            if (teams) {
                allTeams = teams;
                populateTeamFilter();
            }
            return teams;
        }

        async function loadFixtures() {
            showLoading();
            
            // Load fixtures with team information
            const fixtures = await fetchWithErrorHandling(
                `${SUPABASE_URL}/rest/v1/fixtures?select=*,home_team:teams!home_team_id(name,slug),away_team:teams!away_team_id(name,slug)&order=utc_kickoff`
            );
            
            if (fixtures) {
                allFixtures = fixtures;
                populateMatchweekFilter();
                displayFixtures();
            }
            
            hideLoading();
            return fixtures;
        }

        async function loadBroadcasters(fixtureId) {
            return await fetchWithErrorHandling(
                `${SUPABASE_URL}/rest/v1/broadcasts_uk?select=*,provider:providers(*),affiliate:affiliate_destinations(*)&fixture_id=eq.${fixtureId}`
            );
        }

        // Display Functions
        function populateTeamFilter() {
            const teamFilter = document.getElementById('team-filter');
            teamFilter.innerHTML = '<option value="">All Teams</option>';
            
            allTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                teamFilter.appendChild(option);
            });
        }

        function populateMatchweekFilter() {
            const matchweekFilter = document.getElementById('matchweek-filter');
            const matchweeks = [...new Set(allFixtures.map(f => f.matchweek).filter(m => m))].sort((a, b) => a - b);
            
            matchweekFilter.innerHTML = '<option value="">All Matchweeks</option>';
            matchweeks.forEach(matchweek => {
                const option = document.createElement('option');
                option.value = matchweek;
                option.textContent = `Matchweek ${matchweek}`;
                matchweekFilter.appendChild(option);
            });
        }

        function getFilteredFixtures() {
            let filtered = allFixtures;

            // Time filter
            if (currentFilters.time === 'upcoming') {
                const now = new Date();
                filtered = filtered.filter(fixture => new Date(fixture.utc_kickoff) > now);
            }

            // Team filter
            if (currentFilters.team) {
                filtered = filtered.filter(fixture => 
                    fixture.home_team_id == currentFilters.team || 
                    fixture.away_team_id == currentFilters.team
                );
            }

            // Matchweek filter
            if (currentFilters.matchweek) {
                filtered = filtered.filter(fixture => fixture.matchweek == currentFilters.matchweek);
            }

            return filtered;
        }

        async function displayFixtures() {
            const fixturesList = document.getElementById('fixtures-list');
            const filteredFixtures = getFilteredFixtures();

            if (filteredFixtures.length === 0) {
                fixturesList.innerHTML = '<div class="no-fixtures">No fixtures found matching your filters.</div>';
                return;
            }

            let html = '';
            for (const fixture of filteredFixtures) {
                const broadcasters = await loadBroadcasters(fixture.id);
                html += renderFixture(fixture, broadcasters || []);
            }
            
            fixturesList.innerHTML = html;

            // Update page title for SEO
            if (filteredFixtures.length > 0) {
                updatePageTitle(filteredFixtures[0]);
            }
        }

        function renderFixture(fixture, broadcasters) {
            const kickoffDate = new Date(fixture.utc_kickoff);
            const dateStr = kickoffDate.toLocaleDateString('en-GB', {
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });

            const broadcastersHtml = broadcasters.map(broadcast => {
                const providerClass = broadcast.provider?.name?.toLowerCase().replace(/\s+/g, '') || '';
                const affiliateUrl = broadcast.affiliate?.url || '#';
                
                return `<a href="${affiliateUrl}" 
                           class="broadcaster-btn ${providerClass}" 
                           target="_blank"
                           onclick="trackAffiliateClick('${broadcast.provider?.name}', '${fixture.id}')">
                    ${broadcast.provider?.name} ${broadcast.channel_name ? `- ${broadcast.channel_name}` : ''}
                </a>`;
            }).join('');

            return `
                <div class="fixture" data-fixture-id="${fixture.id}">
                    <div class="fixture-header">
                        <div class="fixture-teams">
                            ${fixture.home_team?.name || 'TBD'} vs ${fixture.away_team?.name || 'TBD'}
                        </div>
                        <div class="fixture-date">${dateStr}</div>
                    </div>
                    <div class="broadcasters">
                        ${broadcastersHtml || '<span style="color: #7f8c8d;">Broadcaster TBC</span>'}
                    </div>
                </div>
            `;
        }

        // SEO Functions
        function updatePageTitle(fixture) {
            if (currentFilters.team && fixture) {
                const teamName = allTeams.find(t => t.id == currentFilters.team)?.name;
                if (teamName) {
                    document.title = `${teamName} Fixtures & TV Guide - Where to Watch`;
                }
            }
        }

        function addStructuredData(fixture) {
            // Remove existing structured data
            const existingScript = document.querySelector('script[type="application/ld+json"]');
            if (existingScript) existingScript.remove();

            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.textContent = JSON.stringify({
                "@context": "https://schema.org",
                "@type": "SportsEvent",
                "name": `${fixture.home_team?.name} vs ${fixture.away_team?.name}`,
                "startDate": fixture.utc_kickoff,
                "location": {
                    "@type": "Place",
                    "name": fixture.venue || "TBD"
                },
                "homeTeam": {
                    "@type": "SportsTeam",
                    "name": fixture.home_team?.name
                },
                "awayTeam": {
                    "@type": "SportsTeam", 
                    "name": fixture.away_team?.name
                },
                "sport": "Football"
            });
            document.head.appendChild(script);
        }

        // Analytics Functions
        function trackAffiliateClick(provider, fixtureId) {
            // Track affiliate clicks for revenue optimization
            console.log(`Affiliate click: ${provider} for fixture ${fixtureId}`);
            
            // Send to analytics (implement when ready)
            if (typeof gtag !== 'undefined') {
                gtag('event', 'affiliate_click', {
                    'provider': provider,
                    'fixture_id': fixtureId
                });
            }
        }

        // Event Listeners
        document.getElementById('team-filter').addEventListener('change', (e) => {
            currentFilters.team = e.target.value;
            displayFixtures();
        });

        document.getElementById('matchweek-filter').addEventListener('change', (e) => {
            currentFilters.matchweek = e.target.value;
            displayFixtures();
        });

        document.getElementById('time-filter').addEventListener('change', (e) => {
            currentFilters.time = e.target.value;
            displayFixtures();
        });

        // Initialize App
        async function initApp() {
            try {
                // Load data in parallel
                await Promise.all([
                    loadTeams(),
                    loadFixtures()
                ]);

                // Add structured data for first fixture
                if (allFixtures.length > 0) {
                    addStructuredData(allFixtures[0]);
                }

            } catch (error) {
                console.error('Failed to initialize app:', error);
                showError('Failed to load fixtures. Please refresh the page.');
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);

        // Add service worker for offline capability (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('SW registered'))
                    .catch(() => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>