<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Match • PL UK Listings</title>
  <style>
    :root{--border:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
    a{color:inherit}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:12px;padding:16px;margin:14px 0}
    .btn{display:inline-block;margin-top:10px;border:1px solid #111;padding:10px 14px;border-radius:10px;text-decoration:none}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .chip{border:1px solid #d1d5db;border-radius:999px;padding:4px 12px;font-size:.9rem}
  </style>
</head>
<body>
  <header>
    <div><a href="/"><strong>← Premier League — UK Listings</strong></a></div>
    <div class="muted" id="status">loading…</div>
  </header>

  <div class="wrap" id="app"></div>

  <script type="module">
    // ---- Supabase config ----
    const SUPABASE_URL = "https://ksqyurqkqznzrntdpood.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzcXl1cnFrcXpuenJudGRwb29kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTEwNjAsImV4cCI6MjA3MjM2NzA2MH0.wVBZBEbfctB7JPnpMZkXKMGwXlYxGWjOF_AxixVo-S4";
    const H = { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` };

    const params = new URLSearchParams(location.search);
    const fixtureId = params.get("id");

    const app = document.getElementById("app");
    const statusEl = document.getElementById("status");
    const dtf = new Intl.DateTimeFormat(undefined, { dateStyle:"medium", timeStyle:"short" });

    if (!fixtureId) {
      statusEl.textContent = "";
      app.innerHTML = `<p class="muted">Missing <code>?id=</code> in the URL.</p>`;
      throw new Error("no fixture id");
    }

    try {
      // 1) Fixture
      const [fixture] = await jget(`/rest/v1/fixtures?id=eq.${fixtureId}&select=id,utc_kickoff,home_team_id,away_team_id,venue,status`);
      if (!fixture) {
        statusEl.textContent = "";
        app.innerHTML = `<p class="muted">Fixture not found.</p>`;
        return;
      }

      // 2) Teams
      const teamIds = [fixture.home_team_id, fixture.away_team_id].join(",");
      const teams = await jget(`/rest/v1/teams?id=in.(${teamIds})&select=id,name,slug`);
      const tById = Object.fromEntries(teams.map(t => [t.id, t]));

      // 3) Broadcasts
      const broadcasts = await jget(`/rest/v1/broadcasts_uk?fixture_id=eq.${fixtureId}&select=provider_id,channel_name,stream_type,verified,verified_at,providers!inner(id,display_name,code,type)`);
      const provIds = [...new Set(broadcasts.map(b => b.provider_id))];
      let affiliatesByProv = {};
      if (provIds.length) {
        const aff = await jget(`/rest/v1/affiliate_destinations?provider_id=in.(${provIds.join(",")})&select=provider_id,affiliate_url`);
        affiliatesByProv = Object.fromEntries(aff.map(a => [a.provider_id, a.affiliate_url]));
      }

      // 4) Render
      statusEl.textContent = "";
      const title = `${tById[fixture.home_team_id]?.name ?? fixture.home_team_id} vs ${tById[fixture.away_team_id]?.name ?? fixture.away_team_id}`;
      const when = dtf.format(new Date(fixture.utc_kickoff));
      const venue = fixture.venue ? ` — ${fixture.venue}` : "";

      app.innerHTML = `
        <h1>${title}</h1>
        <div class="muted">${when}${venue}</div>
        <div id="providers"></div>
      `;

      const box = document.getElementById("providers");
      if (!broadcasts.length) {
        box.innerHTML = `<div class="card"><span class="muted">No UK broadcaster listed yet.</span></div>`;
      } else {
        const order = { tv:1, ott:2, radio:3 };
        broadcasts.sort((a,b) => (order[a.stream_type]||9)-(order[b.stream_type]||9));
        box.innerHTML = broadcasts.map(b => {
          const p = b.providers;
          const label = b.channel_name ? `${p.display_name} — ${b.channel_name}` : p.display_name;
          const verify = b.verified ? `✅ Verified ${b.verified_at ?? ""}` : "Unverified";
          const affUrl = affiliatesByProv[b.provider_id] || "";
          const showBtn = (b.stream_type !== "radio") && !!affUrl;
          return `
            <div class="card">
              <div><strong>${label}</strong> <span class="muted">(${b.stream_type})</span></div>
              <div class="muted" style="margin-top:4px">${verify}</div>
              ${showBtn ? `<a class="btn" href="${affUrl}" target="_blank" rel="nofollow noopener">Watch on ${p.display_name}</a>` : ``}
            </div>
          `;
        }).join("");
      }
    } catch (err) {
      console.error(err);
      statusEl.textContent = "";
      app.innerHTML = `<p class="muted">Error loading match: ${err.message}</p>`;
    }

    // ---- helper ----
    async function jget(path){
      const r = await fetch(`${SUPABASE_URL}${path}`, { headers: H });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }
  </script>
</body>
</html>