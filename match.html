<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premier League — UK Listings</title>
  <style>
    :root{--border:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
    a{color:inherit}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:12px;padding:16px;margin:14px 0}
    .btn{display:inline-block;margin-top:10px;border:1px solid #111;padding:10px 14px;border-radius:10px;text-decoration:none}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .chip{border:1px solid #d1d5db;border-radius:999px;padding:4px 12px;font-size:.9rem}
  </style>
</head>
<body>
  <header>
    <div><strong>Premier League — UK Listings</strong></div>
    <div class="muted" id="status">loading…</div>
  </header>

  <div class="wrap" id="app"></div>

  <script type="module">
    const SUPABASE_URL = "https://ksqyurqkqznzrntdpood.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzcXl1cnFrcXpuenJudGRwb29kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTEwNjAsImV4cCI6MjA3MjM2NzA2MH0.wVBZBEbfctB7JPnpMZkXKMGwXlYxGWjOF_AxixVo-S4";
    const H = { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` };

    const app = document.getElementById("app");
    const statusEl = document.getElementById("status");
    const dtf = new Intl.DateTimeFormat(undefined, { dateStyle:"medium", timeStyle:"short" });

    async function homeView(){
      statusEl.textContent = "loading…";
      try {
        const fixtures = await jget(`/rest/v1/fixtures?select=id,utc_kickoff,home_team_id,away_team_id,venue,status&order=utc_kickoff.asc`);

        // Fallback client-side filter to ensure only future fixtures render
        const nowTs = Date.now();
        const upcoming = (fixtures || []).filter(f => {
          const t = Date.parse(f.utc_kickoff);
          return !Number.isNaN(t) && t >= nowTs;
        });

        if (upcoming.length === 0) {
          app.innerHTML = `
            <h1>Premier League — UK Listings</h1>
            <p class="muted">No upcoming fixtures found. Try widening your date range.</p>
          `;
          statusEl.textContent = "";
          return;
        }

        statusEl.textContent = "";
        app.innerHTML = `
          <h1>Premier League — UK Listings</h1>
          <p>Showing ${upcoming.length} upcoming fixtures</p>
          <div id="list"></div>
        `;

        const list = document.getElementById("list");

        const teamIds = [...new Set(upcoming.flatMap(f => [f.home_team_id, f.away_team_id]))].join(",");
        const teams = await jget(`/rest/v1/teams?id=in.(${teamIds})&select=id,name,slug`);
        const tById = Object.fromEntries(teams.map(t => [t.id, t]));
        list.innerHTML = upcoming.map(f => {
          const home = tById[f.home_team_id];
          const away = tById[f.away_team_id];
          const when = dtf.format(new Date(f.utc_kickoff));
          const venue = f.venue ? ` — ${f.venue}` : "";
          return `
            <div class="card">
              <a href="/match.html?id=${f.id}"><strong>${home?.name ?? f.home_team_id} vs ${away?.name ?? f.away_team_id}</strong></a>
              <div class="muted">${when}${venue}</div>
            </div>
          `;
        }).join("");

      } catch (err) {
        console.error(err);
        statusEl.textContent = "";
        app.innerHTML = `<p class="muted">Error loading fixtures: ${err.message}</p>`;
      }
    }

    async function jget(path){
      const r = await fetch(`${SUPABASE_URL}${path}`, { headers: H });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    homeView();
  </script>
</body>
</html>